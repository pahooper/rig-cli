---
phase: 09-codex-adapter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - codex-adapter/src/types.rs
  - codex-adapter/src/cmd.rs
autonomous: true

must_haves:
  truths:
    - "ApprovalPolicy enum exists with all 4 Codex CLI values"
    - "build_args() generates --ask-for-approval flag correctly"
    - "cmd.rs has module-level documentation matching Claude Code pattern"
    - "Flag combination unit tests use windows(2) pattern"
    - "MCP sandbox bypass #4152 is documented in Known Limitations"
  artifacts:
    - path: "codex-adapter/src/types.rs"
      provides: "ApprovalPolicy enum and ask_for_approval field on CodexConfig"
      contains: "ApprovalPolicy"
    - path: "codex-adapter/src/cmd.rs"
      provides: "CLI flag documentation and flag generation"
      contains: "## Flag Reference"
  key_links:
    - from: "codex-adapter/src/cmd.rs"
      to: "types.rs"
      via: "ApprovalPolicy import and match"
      pattern: "ApprovalPolicy::"
---

<objective>
Add ApprovalPolicy enum and comprehensive CLI flag documentation to Codex adapter.

Purpose: Enable approval policy containment (--ask-for-approval flag) and document all containment-relevant CLI flags with the same structure as Claude Code adapter.
Output: ApprovalPolicy enum, updated build_args(), module-level documentation, flag combination tests.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-codex-adapter/09-CONTEXT.md
@.planning/phases/09-codex-adapter/09-RESEARCH.md
@claudecode-adapter/src/cmd.rs (reference for documentation structure)
@codex-adapter/src/types.rs
@codex-adapter/src/cmd.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ApprovalPolicy enum and update CodexConfig</name>
  <files>codex-adapter/src/types.rs</files>
  <action>
Add ApprovalPolicy enum with the 4 Codex CLI values:

```rust
/// Approval policy for command execution.
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq, Default)]
pub enum ApprovalPolicy {
    /// Only run "trusted" commands without asking for user approval.
    /// Escalates to user for untrusted commands.
    #[default]
    Untrusted,
    /// Run all commands without approval. Only asks if a command fails,
    /// offering un-sandboxed re-execution.
    OnFailure,
    /// The model decides when to ask the user for approval.
    OnRequest,
    /// Never ask for user approval. Failures return immediately to model.
    Never,
}
```

Add `ask_for_approval` field to `CodexConfig`:

```rust
/// Approval policy for command execution (--ask-for-approval).
pub ask_for_approval: Option<ApprovalPolicy>,
```

Default is `None` (CLI uses its own default), not `Some(ApprovalPolicy::Untrusted)`.
Derive `Default` on `ApprovalPolicy` with `#[default]` on `Untrusted` variant for explicit default when user wants maximum containment.
  </action>
  <verify>cargo clippy -p codex-adapter -- -W clippy::pedantic (no warnings)</verify>
  <done>ApprovalPolicy enum exists with 4 variants, ask_for_approval field added to CodexConfig with correct default</done>
</task>

<task type="auto">
  <name>Task 2: Update build_args() for --ask-for-approval and add module documentation</name>
  <files>codex-adapter/src/cmd.rs</files>
  <action>
1. Add `ApprovalPolicy` import at top:
   ```rust
   use crate::types::{ApprovalPolicy, CodexConfig, SandboxMode};
   ```

2. Update `build_args()` to generate --ask-for-approval flag:
   ```rust
   if let Some(ref policy) = config.ask_for_approval {
       args.push(OsString::from("--ask-for-approval"));
       match policy {
           ApprovalPolicy::Untrusted => args.push(OsString::from("untrusted")),
           ApprovalPolicy::OnFailure => args.push(OsString::from("on-failure")),
           ApprovalPolicy::OnRequest => args.push(OsString::from("on-request")),
           ApprovalPolicy::Never => args.push(OsString::from("never")),
       }
   }
   ```

3. Add module-level documentation matching Claude Code structure (see claudecode-adapter/src/cmd.rs):

```rust
//! Command-line argument builder for Codex CLI invocations.
//!
//! ## Flag Reference
//!
//! ### Containment Flags
//! - `-s, --sandbox <mode>`: Filesystem isolation (read-only | workspace-write | danger-full-access)
//! - `-a, --ask-for-approval <policy>`: Approval gating (untrusted | on-failure | on-request | never)
//! - `--full-auto`: Convenience alias (-a on-request, --sandbox workspace-write)
//! - `--dangerously-bypass-approvals-and-sandbox`: Disables ALL containment (extremely dangerous)
//!
//! ### Working Directory Flags
//! - `-C, --cd <dir>`: Set working directory for the agent
//! - `--add-dir <dir>`: Additional writable directories (repeatable)
//! - `--skip-git-repo-check`: Allow non-git directories (needed for temp dir containment)
//!
//! ### Model and Output Flags
//! - `-m, --model <model>`: Model to use (e.g., o4-mini)
//! - `--search`: Enable live web search capability
//! - `-c, --config <key=value>`: Override config values
//!
//! ## Flag Combinations and Compatibility
//!
//! ### Valid Containment Combinations
//! | Combination | Effect |
//! |-------------|--------|
//! | `--sandbox read-only` | Landlock enforces read-only filesystem access |
//! | `--ask-for-approval untrusted` | Only known-safe commands auto-run |
//! | `--sandbox read-only -a untrusted` | Maximum containment (both layers) |
//! | `--sandbox read-only --skip-git-repo-check` | Containment in temp directories |
//!
//! ### Invalid/Conflict Combinations
//! | Combination | Issue |
//! |-------------|-------|
//! | `--full-auto` + `--sandbox read-only` | full-auto overrides to workspace-write |
//! | `--full-auto` + `-a untrusted` | full-auto overrides to on-request |
//! | `--sandbox X` + `--dangerously-bypass...` | Bypass disables sandbox entirely |
//!
//! ## Version Notes
//! - `--ask-for-approval`: Available in Codex CLI 0.92.0+
//! - `--sandbox`: Uses Linux Landlock (may have reduced effect on other platforms)
//! - `--full-auto`: Convenience flag since Codex 0.90.0
//!
//! ## Known Limitations
//! - MCP tools bypass Landlock sandbox restrictions (Codex Issue #4152)
//!   ([GitHub #4152](https://github.com/openai/codex/issues/4152))
//!   For strong isolation, use external Docker sandboxes.
//! - `--dangerously-bypass-approvals-and-sandbox` disables ALL containment
//!
//! ## External References
//! - [Codex CLI Reference](https://developers.openai.com/codex/cli/reference/)
```
  </action>
  <verify>cargo clippy -p codex-adapter -- -W clippy::pedantic && cargo doc -p codex-adapter --no-deps (docs render)</verify>
  <done>build_args() generates --ask-for-approval flag, module-level documentation complete with Flag Reference, Combinations, Version Notes, Known Limitations sections</done>
</task>

<task type="auto">
  <name>Task 3: Add flag combination unit tests</name>
  <files>codex-adapter/src/cmd.rs</files>
  <action>
Add unit tests to the existing test module, using windows(2) pattern to verify flag pairs:

1. `test_approval_policy_untrusted_flag` - verify --ask-for-approval untrusted
2. `test_approval_policy_never_flag` - verify --ask-for-approval never
3. `test_sandbox_with_approval_combination` - verify both flags work together
4. `test_full_containment_with_approval` - verify sandbox + approval + skip_git_repo_check + cd
5. `test_full_auto_excludes_manual_containment` - document that full_auto overrides manual settings

Update existing `test_full_containment_config` to include `ask_for_approval: Some(ApprovalPolicy::Untrusted)`.

Example test:
```rust
#[test]
fn test_approval_policy_untrusted_flag() {
    let config = CodexConfig {
        ask_for_approval: Some(ApprovalPolicy::Untrusted),
        ..CodexConfig::default()
    };
    let args = build_args("test prompt", &config);
    let args_str: Vec<&str> = args.iter().filter_map(|s| s.to_str()).collect();

    assert!(
        args_str.windows(2).any(|w| w[0] == "--ask-for-approval" && w[1] == "untrusted"),
        "Expected '--ask-for-approval untrusted' but got: {:?}",
        args_str
    );
}
```
  </action>
  <verify>cargo test -p codex-adapter (all tests pass)</verify>
  <done>5+ new flag combination tests using windows(2) pattern, all tests pass</done>
</task>

</tasks>

<verification>
1. `cargo clippy -p codex-adapter -- -W clippy::pedantic` - no warnings
2. `cargo test -p codex-adapter` - all tests pass (existing + 5 new)
3. `cargo doc -p codex-adapter --no-deps` - module documentation renders correctly
4. Verify ApprovalPolicy enum has 4 variants matching Codex CLI help
</verification>

<success_criteria>
- ApprovalPolicy enum with Untrusted, OnFailure, OnRequest, Never variants
- ask_for_approval field on CodexConfig
- build_args() generates --ask-for-approval flag correctly
- Module-level documentation with Flag Reference, Combinations, Version Notes, Known Limitations
- MCP sandbox bypass #4152 documented in Known Limitations
- 5+ new flag combination unit tests using windows(2) pattern
- All clippy pedantic warnings resolved
</success_criteria>

<output>
After completion, create `.planning/phases/09-codex-adapter/09-01-SUMMARY.md`
</output>
