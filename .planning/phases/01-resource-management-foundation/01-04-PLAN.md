---
phase: 01-resource-management-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - rig-provider/src/adapters/claude.rs
  - rig-provider/src/adapters/codex.rs
  - rig-provider/src/adapters/opencode.rs
autonomous: true

must_haves:
  truths:
    - "rig-provider adapter callers use bounded channels when calling adapter stream() methods"
    - "Entire workspace compiles with cargo check --workspace"
    - "No .expect() or .unwrap() in subprocess-related code paths across workspace"
    - "No unbounded_channel usage remains in the workspace (outside planning/docs)"
    - "cargo clippy --workspace passes without subprocess-related warnings"
  artifacts:
    - path: "rig-provider/src/adapters/claude.rs"
      provides: "Bounded channel creation for Claude streaming"
      contains: "mpsc::channel\\("
    - path: "rig-provider/src/adapters/codex.rs"
      provides: "Bounded channel creation for Codex streaming"
      contains: "mpsc::channel\\("
    - path: "rig-provider/src/adapters/opencode.rs"
      provides: "Bounded channel creation for OpenCode streaming"
      contains: "mpsc::channel\\("
  key_links:
    - from: "rig-provider/src/adapters/claude.rs"
      to: "claudecode-adapter/src/lib.rs"
      via: "cli.stream() call with bounded Sender"
      pattern: "mpsc::channel.*cli\\.stream"
    - from: "rig-provider/src/adapters/codex.rs"
      to: "codex-adapter/src/lib.rs"
      via: "cli.stream() call with bounded Sender"
      pattern: "mpsc::channel.*cli\\.stream"
    - from: "rig-provider/src/adapters/opencode.rs"
      to: "opencode-adapter/src/lib.rs"
      via: "cli.stream() call with bounded Sender"
      pattern: "mpsc::channel.*cli\\.stream"
---

<objective>
Update rig-provider adapter callers to use bounded channels and verify the entire workspace compiles clean.

Purpose: Plans 01-03 changed adapter stream() signatures from UnboundedSender to bounded Sender. The rig-provider/src/adapters/ files create unbounded channels and pass them to adapter stream() methods — they must be updated to create bounded channels instead. This plan also performs the final workspace-wide verification that all RSRC requirements are satisfied.

Output: Updated rig-provider adapter files using bounded channels, clean workspace compilation, and verification that no unbounded channels or panic-prone code remains.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-resource-management-foundation/01-CONTEXT.md
@rig-provider/src/adapters/claude.rs
@rig-provider/src/adapters/codex.rs
@rig-provider/src/adapters/opencode.rs
@rig-provider/Cargo.toml

# Prior plan summaries (needed: adapter API changed)
@.planning/phases/01-resource-management-foundation/01-01-SUMMARY.md
@.planning/phases/01-resource-management-foundation/01-02-SUMMARY.md
@.planning/phases/01-resource-management-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update rig-provider adapter callers from unbounded to bounded channels</name>
  <files>rig-provider/src/adapters/claude.rs, rig-provider/src/adapters/codex.rs, rig-provider/src/adapters/opencode.rs</files>
  <action>
  Update all three rig-provider adapter files to replace unbounded_channel with bounded channel.

  **In each file (claude.rs, codex.rs, opencode.rs), make these changes:**

  1. **Replace channel creation** in the `stream()` method of the CompletionModel impl:
     - Old: `let (tx, rx) = tokio::sync::mpsc::unbounded_channel();`
     - New: `let (tx, rx) = tokio::sync::mpsc::channel(100);` (same CHANNEL_CAPACITY as adapters)

  2. **Replace stream wrapper** — currently uses `UnboundedReceiverStream`:
     - Old import: `use tokio_stream::wrappers::UnboundedReceiverStream;`
     - New import: `use tokio_stream::wrappers::ReceiverStream;`
     - Old usage: `UnboundedReceiverStream::new(rx)`
     - New usage: `ReceiverStream::new(rx)`

  3. **Handle the spawned task error** — currently the background task's error is silently discarded with `let _ = cli.stream(...)`. This is acceptable for now (error handling for the streaming path is a future concern), but change the comment to be explicit:
     ```rust
     tokio::spawn(async move {
         // Error from CLI stream is intentionally dropped here;
         // the receiver will see the channel close and handle accordingly
         let _ = cli.stream(&prompt_str, &config, tx).await;
     });
     ```

  4. **In claude.rs specifically:** The `NonZeroExit` variant in the `call()` method constructs `ClaudeError::NonZeroExit` — this variant now has additional fields (pid, elapsed). Update the error construction to include dummy/default values since the Tool::call path uses `run()` not `stream()`, and the error is constructed from RunResult data:
     - Check if `ClaudeError::NonZeroExit` is still used in claude.rs call() method
     - If yes, update to include the new required fields. Use `pid: 0` and `elapsed: Duration::from_millis(result.duration_ms)` as reasonable defaults since this error is constructed from RunResult, not directly from the subprocess.
     - Same check for codex.rs and opencode.rs

  5. **Check for any other unwrap_or_else or unwrap calls** in these files and replace with proper error handling where feasible. The `schemars::schema_for!` usage with `unwrap_or_else` in definition() is acceptable (it's a schema serialization that should never fail, and it's a ToolDefinition context not subprocess code).

  **Do NOT change:**
  - The ProviderError enum in errors.rs (it uses #[from] which auto-converts the new error types)
  - The CompletionModel impl structure
  - The Tool impl structure
  - Any non-channel-related logic
  </action>
  <verify>
  Run `cargo check --workspace`. The entire workspace must compile without errors.
  </verify>
  <done>
  All three rig-provider adapter files use `mpsc::channel(100)` and `ReceiverStream` instead of unbounded equivalents. Workspace compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Workspace-wide verification of RSRC requirements</name>
  <files>None (verification only)</files>
  <action>
  Run comprehensive verification across the entire workspace to confirm all five RSRC requirements are satisfied.

  **RSRC-01: Bounded channels**
  - Run: `grep -rn "unbounded_channel\|UnboundedSender\|UnboundedReceiver\|UnboundedReceiverStream" --include="*.rs" claudecode-adapter/ codex-adapter/ opencode-adapter/ rig-provider/src/`
  - Expected: ZERO matches (all unbounded usage eliminated from source code)

  **RSRC-02: JoinSet task tracking**
  - Run: `grep -rn "JoinSet" --include="*.rs" claudecode-adapter/src/process.rs codex-adapter/src/process.rs opencode-adapter/src/process.rs`
  - Expected: At least one match per file (JoinSet used in all three adapters)

  **RSRC-03: Graceful subprocess cleanup**
  - Run: `grep -rn "SIGTERM\|graceful_shutdown\|GRACE_PERIOD" --include="*.rs" claudecode-adapter/src/ codex-adapter/src/ opencode-adapter/src/`
  - Expected: Matches in all three adapter directories

  **RSRC-04: Stream draining**
  - Run: `grep -rn "drain_stream_bounded\|MAX_OUTPUT_BYTES" --include="*.rs" claudecode-adapter/src/ codex-adapter/src/ opencode-adapter/src/`
  - Expected: Matches in all three adapter directories

  **RSRC-05: No panics in stream handling**
  - Run: `grep -rn "\.expect(\|\.unwrap(\|panic!" --include="*.rs" claudecode-adapter/src/process.rs codex-adapter/src/process.rs opencode-adapter/src/process.rs`
  - Expected: ZERO matches

  **Clippy verification:**
  - Run: `cargo clippy --workspace -- -D warnings` (treat all warnings as errors)
  - If there are pre-existing clippy warnings in non-process code, document them but do not fix (out of scope for this phase — only subprocess code must be clean)
  - If clippy fails due to new code introduced in Plans 01-03, fix those issues in the relevant adapter files

  **Compilation:**
  - Run: `cargo check --workspace`
  - Must pass with zero errors

  If any verification fails, fix the issue in the relevant file before completing this task. Document what was fixed.
  </action>
  <verify>
  All six verification commands produce expected results. `cargo check --workspace` passes. `cargo clippy --workspace` passes or only has pre-existing warnings in code outside the scope of this phase.
  </verify>
  <done>
  RSRC-01 through RSRC-05 verified across all three adapters and rig-provider. Zero unbounded channels in source code. JoinSet in all process.rs files. SIGTERM/SIGKILL in all adapters. Stream draining with memory limits in all adapters. Zero .expect()/.unwrap()/panic! in subprocess code. Workspace compiles and passes clippy.
  </done>
</task>

</tasks>

<verification>
1. `cargo check --workspace` passes with zero errors
2. `cargo clippy --workspace` passes (or only pre-existing warnings outside phase scope)
3. Zero `unbounded_channel` / `UnboundedSender` / `UnboundedReceiverStream` in source .rs files under adapter and rig-provider directories
4. `JoinSet` present in all three process.rs files
5. `SIGTERM` / `graceful_shutdown` present in all three adapter directories
6. `drain_stream_bounded` / `MAX_OUTPUT_BYTES` present in all three adapter directories
7. Zero `.expect()` / `.unwrap()` / `panic!` in any process.rs file
</verification>

<success_criteria>
- Entire workspace compiles with `cargo check --workspace`
- All RSRC-01 through RSRC-05 requirements verified by grep/clippy
- No unbounded channels remain in production code
- rig-provider adapter callers use bounded channels with ReceiverStream
- Zero panics possible in subprocess execution paths
</success_criteria>

<output>
After completion, create `.planning/phases/01-resource-management-foundation/01-04-SUMMARY.md`
</output>
