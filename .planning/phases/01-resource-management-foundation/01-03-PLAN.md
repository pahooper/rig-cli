---
phase: 01-resource-management-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - opencode-adapter/Cargo.toml
  - opencode-adapter/src/error.rs
  - opencode-adapter/src/process.rs
  - opencode-adapter/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "opencode-adapter subprocess spawning never panics on missing stdout/stderr"
    - "opencode-adapter uses bounded channels for internal stream communication"
    - "opencode-adapter tracks spawned tasks via JoinSet and aborts on timeout/drop"
    - "opencode-adapter sends SIGTERM before SIGKILL on timeout with grace period"
    - "opencode-adapter drains remaining buffered output before cleanup"
    - "opencode-adapter enforces hard memory limit on accumulated output"
    - "opencode-adapter error types carry subprocess PID, elapsed time, and pipeline stage"
  artifacts:
    - path: "opencode-adapter/src/error.rs"
      provides: "Rich OpenCodeError enum with subprocess context variants"
      contains: "Timeout.*pid.*elapsed|SpawnFailed.*stage|StreamFailed|SignalFailed|OutputTruncated"
    - path: "opencode-adapter/src/process.rs"
      provides: "Subprocess execution with bounded channels, JoinSet, graceful shutdown"
      contains: "mpsc::channel|JoinSet|SIGTERM|GRACE_PERIOD|MAX_OUTPUT_BYTES"
    - path: "opencode-adapter/src/lib.rs"
      provides: "Public API with bounded Sender for streaming"
      contains: "mpsc::Sender"
  key_links:
    - from: "opencode-adapter/src/process.rs"
      to: "opencode-adapter/src/error.rs"
      via: "Error propagation from all fallible operations"
      pattern: "OpenCodeError::"
    - from: "opencode-adapter/src/process.rs"
      to: "tokio::task::JoinSet"
      via: "Task tracking for stdout/stderr reader tasks"
      pattern: "JoinSet::new|tasks\\.spawn"
    - from: "opencode-adapter/src/process.rs"
      to: "nix::sys::signal"
      via: "SIGTERM for graceful subprocess shutdown"
      pattern: "kill.*Signal::SIGTERM"
---

<objective>
Rewrite opencode-adapter subprocess execution with bounded resources and zero panics.

Purpose: The opencode-adapter has identical resource management problems to the other adapters. While OpenCode is deprioritized for production hardening, the resource management fixes (bounded channels, no panics, graceful shutdown) are infrastructure-level concerns that affect system stability regardless of adapter priority. This plan applies the same pattern.

Output: A fully rewritten error.rs, process.rs, and updated lib.rs in opencode-adapter satisfying RSRC-01 through RSRC-05 for this crate.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-resource-management-foundation/01-CONTEXT.md
@.planning/phases/01-resource-management-foundation/01-RESEARCH.md
@opencode-adapter/src/error.rs
@opencode-adapter/src/process.rs
@opencode-adapter/src/lib.rs
@opencode-adapter/src/types.rs
@opencode-adapter/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add nix dependency and rewrite OpenCodeError with rich subprocess context</name>
  <files>opencode-adapter/Cargo.toml, opencode-adapter/src/error.rs</files>
  <action>
  1. In Cargo.toml, add `nix = { version = "0.29", features = ["signal"] }` to dependencies.

  2. Rewrite error.rs to replace the current OpenCodeError enum with rich subprocess context variants. Keep existing non-subprocess variants (ExecutableNotFound, WhichError) but replace/enhance subprocess-related ones:

  **Remove:**
  - `SpawnFailed(#[from] std::io::Error)` — replace with richer version
  - `Timeout(std::time::Duration)` — replace with version carrying partial output
  - `NonZeroExit { exit_code, stdout, stderr }` — add PID and elapsed time
  - `AnyhowError(#[from] anyhow::Error)` — keep only if used outside process.rs
  - `Other(String)` — replace with specific variants

  **Add these subprocess-specific variants (same pattern as other adapters):**
  - `SpawnFailed { stage: String, source: std::io::Error }` — with #[source]
  - `Timeout { elapsed: std::time::Duration, pid: u32, partial_stdout: String, partial_stderr: String }`
  - `NonZeroExit { exit_code: i32, pid: u32, elapsed: std::time::Duration, stdout: String, stderr: String }`
  - `StreamFailed { stage: String, source: tokio::task::JoinError }` — with #[source]
  - `SignalFailed { signal: String, pid: u32, source: nix::errno::Errno }` — with #[source]
  - `NoStdout`
  - `NoStderr`
  - `NoPid`
  - `OutputTruncated { captured_bytes: usize, limit_bytes: usize }`
  - `ChannelClosed { stage: String }`

  Keep `ExecutableNotFound(String)` and `WhichError(#[from] which::Error)`.
  Keep `AnyhowError(#[from] anyhow::Error)` only if grep confirms usage outside process.rs.

  Add manual `impl From<std::io::Error> for OpenCodeError` mapping to SpawnFailed with default stage.

  IMPORTANT: Do NOT use #[source] on String fields.
  </action>
  <verify>
  Verify error.rs is syntactically valid.
  </verify>
  <done>opencode-adapter/src/error.rs has rich context error variants. nix dependency added to Cargo.toml.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite process.rs with bounded channels, JoinSet, graceful shutdown, and update lib.rs API</name>
  <files>opencode-adapter/src/process.rs, opencode-adapter/src/lib.rs</files>
  <action>
  **Rewrite process.rs completely** following the same architecture.

  **Constants:**
  ```
  const CHANNEL_CAPACITY: usize = 100;
  const MAX_OUTPUT_BYTES: usize = 10 * 1024 * 1024; // 10 MB
  const GRACE_PERIOD: Duration = Duration::from_secs(5);
  ```

  **Function signature change:**
  Change `sender: Option<tokio::sync::mpsc::UnboundedSender<crate::types::StreamEvent>>` to `sender: Option<tokio::sync::mpsc::Sender<crate::types::StreamEvent>>` (bounded).

  **Implementation flow (same pattern, adapted for opencode):**
  1. Spawn subprocess, take stdout/stderr with `?`, get PID
  2. Bounded internal channels + JoinSet with reader tasks
  3. stdout reader: JSONL parse attempt for StreamEvent forwarding, bounded accumulation
  4. stderr reader: simple bounded accumulation
  5. Main select! loop accumulating into Vec<String>
  6. Timeout wrapper, graceful SIGTERM/SIGKILL shutdown
  7. Return RunResult (opencode RunResult: stdout, stderr, exit_code, duration_ms)

  **OpenCode-specific differences:**
  - Config uses `config.cwd` for current_dir (same as claude, unlike codex's `config.cd`)
  - No env setting from config
  - Simpler RunResult (no json, no stream_events)
  - JSONL parsing for StreamEvent is similar to codex pattern (try parse, fallback to Text event)

  **Helper functions:** Same `drain_stream_bounded` and `graceful_shutdown`.

  **Remove:** All Arc<Mutex<String>>, .expect(), bare child.kill(), untracked tokio::spawn.

  **Update lib.rs:**
  Change `OpenCodeCli::stream()` signature from `UnboundedSender` to `Sender` (bounded).
  </action>
  <verify>
  Run `cargo check -p opencode-adapter`. Should compile with zero errors.
  Run `cargo clippy -p opencode-adapter -- -W clippy::unwrap_used -W clippy::expect_used -W clippy::panic` and verify zero violations in process.rs.
  </verify>
  <done>
  opencode-adapter/src/process.rs uses bounded channels, JoinSet, SIGTERM->SIGKILL, bounded accumulation, zero .expect()/.unwrap(). lib.rs stream() uses bounded Sender. `cargo check -p opencode-adapter` passes.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p opencode-adapter` compiles without errors
2. `grep -n "\.expect\(\|\.unwrap\(\|panic!" opencode-adapter/src/process.rs` returns zero matches
3. `grep -n "unbounded" opencode-adapter/src/process.rs opencode-adapter/src/lib.rs` returns zero matches
4. `grep -n "JoinSet" opencode-adapter/src/process.rs` returns at least one match
5. `grep -n "SIGTERM\|Signal::SIGTERM" opencode-adapter/src/process.rs` returns at least one match
6. `grep -n "mpsc::channel" opencode-adapter/src/process.rs` returns at least one match
7. `grep -n "MAX_OUTPUT_BYTES" opencode-adapter/src/process.rs` returns at least one match
</verification>

<success_criteria>
- opencode-adapter compiles with `cargo check`
- process.rs contains zero .expect(), .unwrap(), or panic! calls
- Internal channels are bounded with explicit capacity
- Tasks tracked via JoinSet
- Graceful SIGTERM/SIGKILL shutdown with 5s grace period
- Output capped at 10MB
- Error types carry PID, elapsed time, partial output
- lib.rs stream() uses bounded Sender
</success_criteria>

<output>
After completion, create `.planning/phases/01-resource-management-foundation/01-03-SUMMARY.md`
</output>
