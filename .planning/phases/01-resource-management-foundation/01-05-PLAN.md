---
phase: 01-resource-management-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-04"]
files_modified:
  - opencode-adapter/src/process.rs
  - codex-adapter/src/process.rs
autonomous: true

must_haves:
  truths:
    - "opencode-adapter graceful_shutdown returns Result instead of using eprintln!"
    - "codex-adapter and opencode-adapter graceful_shutdown take &mut child and call child.wait() to prevent zombies"
    - "Both adapters use timeout(GRACE_PERIOD, child.wait()) instead of sleep(GRACE_PERIOD) for early exit"
    - "Timeout paths use let _ = to ignore shutdown errors, always returning Timeout error"
  artifacts:
    - path: "opencode-adapter/src/process.rs"
      provides: "graceful_shutdown with proper error returns and child reaping"
      contains: "child\\.wait\\(\\)|child\\.kill\\(\\)"
    - path: "codex-adapter/src/process.rs"
      provides: "graceful_shutdown with child reaping to prevent zombies"
      contains: "child\\.wait\\(\\)|child\\.kill\\(\\)"
---

<objective>
Fix graceful_shutdown in codex-adapter and opencode-adapter to match claudecode-adapter's pattern.

Purpose: Two issues remain from Wave 1/2 verification: (1) opencode-adapter uses eprintln! in graceful_shutdown instead of returning errors, and (2) both codex and opencode never call child.wait() in their timeout paths, creating potential zombie processes. The claudecode-adapter already has the correct pattern.

Output: Both adapters' graceful_shutdown functions take &mut child, return Result, use timeout-based wait instead of sleep, and always reap the child process.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite opencode-adapter graceful_shutdown to match claude pattern</name>
  <files>opencode-adapter/src/process.rs</files>
  <action>
  Rewrite graceful_shutdown to:
  1. Take `child: &mut tokio::process::Child` and `pid: u32`
  2. Return `Result<(), OpenCodeError>`
  3. Use `timeout(GRACE_PERIOD, child.wait())` instead of `sleep(GRACE_PERIOD)`
  4. Add `child.kill()` + `child.wait()` fallback when grace period expires
  5. Replace `eprintln!` with proper error returns via `map_err`

  Update timeout caller to pass `&mut child` and use `let _ =` to ignore shutdown errors.
  </action>
</task>

<task type="auto">
  <name>Task 2: Rewrite codex-adapter graceful_shutdown to include child reaping</name>
  <files>codex-adapter/src/process.rs</files>
  <action>
  Rewrite graceful_shutdown to:
  1. Also take `child: &mut tokio::process::Child`
  2. Use `timeout(GRACE_PERIOD, child.wait())` instead of `sleep(GRACE_PERIOD)`
  3. Add `child.kill()` + `child.wait()` fallback when grace period expires

  Update timeout caller to pass `&mut child` and use `let _ =` to ignore shutdown errors (currently uses `?` which masks Timeout error).
  </action>
</task>

</tasks>

<verification>
1. `cargo check --workspace` passes
2. `grep -n "eprintln" opencode-adapter/src/process.rs` returns zero matches
3. `grep -n "child.wait\|child.kill" opencode-adapter/src/process.rs codex-adapter/src/process.rs` shows reaping in both graceful_shutdown functions
4. `grep -n "sleep(GRACE_PERIOD)" opencode-adapter/src/process.rs codex-adapter/src/process.rs` returns zero matches
</verification>
