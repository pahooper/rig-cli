---
phase: 04-agent-containment
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - claudecode-adapter/src/cmd.rs
  - codex-adapter/src/cmd.rs
autonomous: true

must_haves:
  truths:
    - "Claude Code containment flags produce correct CLI arguments"
    - "Codex containment flags produce correct CLI arguments"
    - "BuiltinToolSet::None generates --tools '' argument"
    - "disable_slash_commands generates --disable-slash-commands argument"
    - "strict MCP generates --strict-mcp-config argument"
    - "SandboxMode::ReadOnly generates --sandbox read-only argument"
    - "Workspace compiles and all tests pass"
  artifacts:
    - path: "claudecode-adapter/src/cmd.rs"
      provides: "Unit tests for containment flag CLI arg generation"
      contains: "#[test]"
    - path: "codex-adapter/src/cmd.rs"
      provides: "Unit tests for containment flag CLI arg generation"
      contains: "#[test]"
  key_links:
    - from: "ToolPolicy with BuiltinToolSet::None"
      to: "CLI args"
      via: "build_args function"
      pattern: '--tools.*""'
    - from: "CodexConfig with SandboxMode::ReadOnly"
      to: "CLI args"
      via: "build_args function"
      pattern: "--sandbox.*read-only"
---

<objective>
Audit and test CLI flag generation for containment settings in Claude Code and Codex adapters.

Purpose: CONT-03 requires that per-CLI flags are audited and applied correctly. Plan 01 set the containment defaults; this plan verifies those flags reach the CLI correctly through unit tests on the build_args functions, ensuring the containment posture is not just configured but actually enforced at the CLI level.

Output: Unit tests in claudecode-adapter/src/cmd.rs and codex-adapter/src/cmd.rs proving containment flags generate correct CLI arguments. Workspace compiles and tests pass.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-containment/04-RESEARCH.md
@.planning/phases/04-agent-containment/04-01-SUMMARY.md
@claudecode-adapter/src/cmd.rs
@claudecode-adapter/src/types.rs
@codex-adapter/src/cmd.rs
@codex-adapter/src/types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Claude Code containment flag tests to cmd.rs</name>
  <files>claudecode-adapter/src/cmd.rs</files>
  <action>
Add a `#[cfg(test)] mod tests` block at the bottom of `claudecode-adapter/src/cmd.rs` with the following unit tests:

1. `test_builtin_none_generates_empty_tools_flag`: Create a RunConfig with `BuiltinToolSet::None`, call `build_args`, assert the args contain `--tools` followed by `""` (empty string). This is the CONT-01 core assertion -- builtins disabled produces `--tools ""`.

2. `test_builtin_explicit_generates_tools_flag`: Create a RunConfig with `BuiltinToolSet::Explicit(vec!["Bash".to_string()])`, call `build_args`, assert args contain `--tools` followed by `"Bash"`. This is the CONT-02 assertion -- opt-in builtins are passed correctly.

3. `test_disable_slash_commands_flag`: Create a RunConfig with `disable_slash_commands: true`, call `build_args`, assert args contain `--disable-slash-commands`. This prevents /bash and /edit escape.

4. `test_strict_mcp_config_flag`: Create a RunConfig with `mcp: Some(McpPolicy { configs: vec!["test.json".to_string()], strict: true })`, call `build_args`, assert args contain both `--mcp-config` and `--strict-mcp-config`.

5. `test_allowed_tools_flag`: Create a RunConfig with `allowed: Some(vec!["mcp__rig__submit".to_string()])`, call `build_args`, assert args contain `--allowed-tools` followed by `"mcp__rig__submit"`.

6. `test_full_containment_config`: Create a RunConfig with all containment settings (BuiltinToolSet::None, allowed MCP tools, disable_slash_commands, strict MCP, cwd set), call `build_args`, assert all containment flags are present. This is the integration-level assertion for CONT-03.

Helper: Use `RunConfig::default()` as base and override specific fields for each test. Convert OsString args to &str with `.to_str().unwrap()` for assertions.

Use `assert!(args.windows(2).any(|w| ...))` pattern to find adjacent flag-value pairs.
  </action>
  <verify>
`cargo test -p claudecode-adapter -- --nocapture` passes all 6 new tests.
  </verify>
  <done>
6 unit tests in claudecode-adapter/src/cmd.rs verify: BuiltinToolSet::None -> --tools "", BuiltinToolSet::Explicit -> --tools "Bash", disable_slash_commands -> --disable-slash-commands, strict MCP -> --strict-mcp-config, allowed tools -> --allowed-tools, full containment config produces all flags.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Codex containment flag tests and workspace verification</name>
  <files>codex-adapter/src/cmd.rs</files>
  <action>
Add a `#[cfg(test)] mod tests` block at the bottom of `codex-adapter/src/cmd.rs` with the following unit tests:

1. `test_sandbox_readonly_flag`: Create a CodexConfig with `sandbox: Some(SandboxMode::ReadOnly)`, call `build_args`, assert args contain `--sandbox` followed by `"read-only"`. This is the CONT-04 core assertion for Codex.

2. `test_sandbox_workspace_write_flag`: Create a CodexConfig with `sandbox: Some(SandboxMode::WorkspaceWrite)`, call `build_args`, assert args contain `--sandbox` followed by `"workspace-write"`.

3. `test_approval_never_flag`: Create a CodexConfig with `ask_for_approval: Some(ApprovalPolicy::Never)`, call `build_args`, assert args contain `--ask-for-approval` followed by `"never"`. Non-interactive agent execution.

4. `test_cd_flag`: Create a CodexConfig with `cd: Some(PathBuf::from("/tmp/sandbox"))`, call `build_args`, assert args contain `--cd` followed by `"/tmp/sandbox"`. Working directory isolation.

5. `test_full_auto_not_set_by_default`: Create a CodexConfig::default(), call `build_args`, assert args do NOT contain `--full-auto`. CONT-03 audit: full_auto bypasses containment.

6. `test_full_containment_config`: Create a CodexConfig with sandbox ReadOnly, approval Never, cd set, full_auto false, call `build_args`, assert all containment flags present and --full-auto absent.

After writing tests, run:
- `cargo test -p codex-adapter -- --nocapture` -- all tests pass
- `cargo test --workspace -- --nocapture 2>&1 | tail -20` -- no regressions
- `cargo check --workspace` -- clean compilation

Document known limitation as a comment in the Codex test module:
```rust
// NOTE: Codex Issue #4152 -- MCP tools bypass sandbox restrictions.
// This means our MCP tools (submit/validate/example) are NOT subject to
// Codex's Landlock sandbox enforcement. For strong isolation, use
// Docker Sandboxes externally. This is a known Codex bug, not a rig-cli issue.
```
  </action>
  <verify>
1. `cargo test -p codex-adapter -- --nocapture` passes all 6 new tests
2. `cargo test --workspace -- --nocapture 2>&1 | tail -20` shows no failures
3. `cargo check --workspace` compiles cleanly
  </verify>
  <done>
- 6 unit tests in codex-adapter/src/cmd.rs verify sandbox, approval, cd, and full_auto flag generation
- Codex MCP sandbox bypass limitation documented inline
- Workspace compiles and all tests pass (both adapter crates + workspace)
  </done>
</task>

</tasks>

<verification>
1. `cargo test -p claudecode-adapter` -- all tests pass, 6+ tests total
2. `cargo test -p codex-adapter` -- all tests pass, 6+ tests total
3. `cargo test --workspace` -- no regressions across workspace
4. `cargo check --workspace` -- clean compilation
5. `grep -r "#\[test\]" claudecode-adapter/src/cmd.rs` -- at least 6 matches
6. `grep -r "#\[test\]" codex-adapter/src/cmd.rs` -- at least 6 matches
</verification>

<success_criteria>
- Claude Code containment flags (--tools "", --disable-slash-commands, --strict-mcp-config, --allowed-tools) verified via unit tests
- Codex containment flags (--sandbox read-only, --ask-for-approval never, --cd) verified via unit tests
- Full-auto absence verified (not set by default)
- Codex MCP sandbox bypass limitation documented
- Workspace compiles and all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-containment/04-02-SUMMARY.md`
</output>
