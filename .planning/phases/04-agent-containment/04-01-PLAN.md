---
phase: 04-agent-containment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - rig-provider/src/mcp_agent.rs
autonomous: true

must_haves:
  truths:
    - "McpToolAgentBuilder defaults to all builtins disabled (MCP-only mode)"
    - "Developer can opt-in to specific builtin tools via .allow_builtins()"
    - "Agent executes in a temp directory by default, not host filesystem"
    - "Developer can override working directory via .working_dir()"
    - "Claude Code runs with --tools '' and --disable-slash-commands by default"
    - "Codex runs with --sandbox read-only by default"
  artifacts:
    - path: "rig-provider/src/mcp_agent.rs"
      provides: "Containment-first McpToolAgentBuilder with opt-in escape hatches"
      contains: "allow_builtins"
  key_links:
    - from: "McpToolAgentBuilder"
      to: "run_claude_code"
      via: "builtin_tools field propagated to ToolPolicy"
      pattern: "BuiltinToolSet::None"
    - from: "McpToolAgentBuilder"
      to: "run_codex"
      via: "sandbox_mode field propagated to CodexConfig"
      pattern: "SandboxMode::ReadOnly"
    - from: "McpToolAgentBuilder"
      to: "TempDir"
      via: "temp dir created and passed as cwd to adapter configs"
      pattern: "TempDir::new"
---

<objective>
Add containment-first defaults and opt-in escape hatches to McpToolAgentBuilder.

Purpose: Agents must be locked to MCP tools only by default (CONT-01), with developer opt-in for specific builtins (CONT-02), and sandboxed to temp directories (CONT-04). This prevents agents from escaping MCP tool constraints via builtin file editing, bash, or slash commands.

Output: Updated mcp_agent.rs with locked-down defaults, builder opt-in methods, and temp dir sandboxing applied to all three adapter run functions.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-containment/04-RESEARCH.md
@rig-provider/src/mcp_agent.rs
@claudecode-adapter/src/types.rs
@codex-adapter/src/types.rs
@opencode-adapter/src/types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add containment fields and opt-in API to McpToolAgentBuilder</name>
  <files>rig-provider/src/mcp_agent.rs</files>
  <action>
Add three new fields to `McpToolAgentBuilder`:

1. `builtin_tools: Option<Vec<String>>` -- None means "disable all builtins" (default). Some(vec!["Bash"]) means "allow these specific builtins alongside MCP tools."

2. `sandbox_mode: Option<codex_adapter::SandboxMode>` -- Codex sandbox mode. Default: Some(SandboxMode::ReadOnly). Developer can set to WorkspaceWrite or DangerFullAccess if needed.

3. `working_dir: Option<std::path::PathBuf>` -- Override for the execution working directory. When None (default), a temp dir is created automatically. When Some(path), that path is used instead of temp dir.

Add corresponding builder methods:

```rust
/// Opts in to specific builtin tools alongside MCP tools.
///
/// By default, ALL builtin tools are disabled (CONT-01). Call this method
/// to explicitly allow specific builtins like "Bash" or "Read".
///
/// For Claude Code: maps to --tools flag with listed tools.
/// For Codex: no direct equivalent (Codex builtins are controlled by sandbox mode).
/// For OpenCode: documented as best-effort (no CLI flags for tool restriction).
pub fn allow_builtins(mut self, tools: Vec<String>) -> Self

/// Sets the Codex sandbox isolation level.
///
/// Default: SandboxMode::ReadOnly (most restrictive).
/// Only affects Codex adapter; Claude Code and OpenCode ignore this setting.
pub fn sandbox_mode(mut self, mode: codex_adapter::SandboxMode) -> Self

/// Overrides the default temp directory with a specific working directory.
///
/// By default, agents execute in an auto-created temp directory (CONT-04).
/// Call this to use a specific directory instead. The caller is responsible
/// for the lifetime of the provided directory.
pub fn working_dir(mut self, path: impl Into<std::path::PathBuf>) -> Self
```

Initialize defaults in `McpToolAgentBuilder::new()`:
- `builtin_tools: None` (means all disabled)
- `sandbox_mode: Some(codex_adapter::SandboxMode::ReadOnly)`
- `working_dir: None` (means auto temp dir)
  </action>
  <verify>
The file compiles: `cargo check -p rig-provider 2>&1 | tail -5` shows no errors.
The three new builder methods exist and can be chained.
  </verify>
  <done>
McpToolAgentBuilder has builtin_tools, sandbox_mode, working_dir fields with correct defaults. Three builder methods (allow_builtins, sandbox_mode, working_dir) are public and documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply containment settings in per-adapter run functions</name>
  <files>rig-provider/src/mcp_agent.rs</files>
  <action>
Update `McpToolAgentBuilder::run()` to:

1. Create a temp dir if `working_dir` is None. Use `tempfile::TempDir::new()` and keep the TempDir alive (bind to `_temp_dir` in the run method scope, BEFORE the adapter call). If `working_dir` is Some, use that path. Store the resolved `PathBuf` as `effective_cwd`.

2. Pass `builtin_tools` and `sandbox_mode` and `effective_cwd` to the per-adapter run functions by adding them as parameters.

Update `run_claude_code()`:
- Add parameters: `builtin_tools: &Option<Vec<String>>`, `cwd: &std::path::Path`
- Change `BuiltinToolSet::Default` to: if builtin_tools is None, use `BuiltinToolSet::None`; if Some(tools), use `BuiltinToolSet::Explicit(tools.clone())`
- Set `disable_slash_commands: true` always (prevent /bash, /edit escapes)
- Set `mcp.strict: true` (force MCP-only config, ignore global MCP configs)
- Set `cwd: Some(cwd.to_path_buf())`

Update `run_codex()`:
- Add parameters: `sandbox_mode: &codex_adapter::SandboxMode`, `cwd: &std::path::Path`
- Change `full_auto: true` to `full_auto: false` -- full_auto bypasses sandbox and approval safety
- Add `sandbox: Some(sandbox_mode.clone())`
- Add `cd: Some(cwd.to_path_buf())`
- Add `ask_for_approval: Some(codex_adapter::ApprovalPolicy::Never)` -- non-interactive agent execution

Update `run_opencode()`:
- Add parameter: `cwd: &std::path::Path`
- Set `cwd: Some(cwd.to_path_buf())`
- OpenCode lacks CLI containment flags -- temp dir cwd is best-effort containment

IMPORTANT: The TempDir must be created in `McpToolAgentBuilder::run()` BEFORE the match on adapter, and `_temp_dir` must live until after the adapter result is returned. Pattern:

```rust
let (_temp_dir, effective_cwd) = match self.working_dir {
    Some(dir) => (None, dir),
    None => {
        let td = tempfile::TempDir::new()
            .map_err(|e| ProviderError::McpToolAgent(format!("Failed to create temp dir: {e}")))?;
        let path = td.path().to_path_buf();
        (Some(td), path)
    }
};
// _temp_dir lives until end of run(), keeping temp dir alive during execution
```

Do NOT use full_auto for Codex anymore. The research doc explicitly warns: "full_auto sets approval to on-request and sandbox to workspace-write, reducing friction but removing untrusted-mode protections."
  </action>
  <verify>
1. `cargo check -p rig-provider 2>&1 | tail -5` shows no errors
2. `cargo check --workspace 2>&1 | tail -5` shows no errors (no downstream breakage)
3. Grep for `BuiltinToolSet::Default` in mcp_agent.rs -- should NOT appear (replaced with containment logic)
4. Grep for `full_auto: true` in mcp_agent.rs -- should NOT appear (changed to false)
5. Grep for `TempDir::new` in mcp_agent.rs -- should appear in run() method
  </verify>
  <done>
- run_claude_code uses BuiltinToolSet::None by default, strict MCP, slash commands disabled, temp dir cwd
- run_codex uses SandboxMode::ReadOnly by default, no full_auto, temp dir cwd
- run_opencode uses temp dir cwd (best-effort)
- TempDir RAII pattern keeps temp dir alive during execution
- Developer opt-in via allow_builtins/sandbox_mode/working_dir is propagated to adapter configs
  </done>
</task>

</tasks>

<verification>
1. `cargo check --workspace` compiles without errors
2. `grep -n "BuiltinToolSet::Default" rig-provider/src/mcp_agent.rs` returns nothing (no longer using Default)
3. `grep -n "full_auto: true" rig-provider/src/mcp_agent.rs` returns nothing (no longer using full_auto)
4. `grep -n "BuiltinToolSet::None" rig-provider/src/mcp_agent.rs` returns at least 1 match
5. `grep -n "SandboxMode::ReadOnly" rig-provider/src/mcp_agent.rs` returns at least 1 match
6. `grep -n "TempDir::new" rig-provider/src/mcp_agent.rs` returns at least 1 match
7. `grep -n "disable_slash_commands: true" rig-provider/src/mcp_agent.rs` returns at least 1 match
8. `grep -n "strict: true" rig-provider/src/mcp_agent.rs` returns at least 1 match
</verification>

<success_criteria>
- McpToolAgentBuilder defaults lock agents to MCP-only mode (no builtins, no slash commands, strict MCP)
- Developer can opt-in to specific builtins via .allow_builtins(vec!["Bash"])
- All adapter executions run in temp dir by default (RAII cleanup)
- Codex uses read-only sandbox instead of full_auto
- Workspace compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-containment/04-01-SUMMARY.md`
</output>
