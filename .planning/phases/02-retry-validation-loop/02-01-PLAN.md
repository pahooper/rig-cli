---
phase: 02-retry-validation-loop
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/src/extraction/mod.rs
  - mcp/src/extraction/error.rs
  - mcp/src/extraction/metrics.rs
  - mcp/src/extraction/feedback.rs
  - mcp/src/extraction/config.rs
autonomous: true

must_haves:
  truths:
    - "ExtractionError::MaxRetriesExceeded variant holds attempts, max_attempts, history, raw_output, and metrics"
    - "ExtractionMetrics tracks attempt count, wall time, estimated input tokens, and estimated output tokens"
    - "AttemptRecord captures attempt number, submitted JSON, validation errors, raw agent output, and elapsed time"
    - "Token estimation uses chars().count() / 4 heuristic (not bytes().len())"
    - "Validation feedback includes full schema, echoed submission, all errors with instance paths, and attempt counter"
    - "ExtractionConfig has configurable max_attempts (default 3) and include_schema_in_feedback (default true)"
  artifacts:
    - path: "mcp/src/extraction/mod.rs"
      provides: "Module declarations and re-exports for extraction submodules"
      contains: "pub mod error"
    - path: "mcp/src/extraction/error.rs"
      provides: "ExtractionError enum and AttemptRecord struct"
      exports: ["ExtractionError", "AttemptRecord"]
    - path: "mcp/src/extraction/metrics.rs"
      provides: "ExtractionMetrics struct and estimate_tokens function"
      exports: ["ExtractionMetrics", "estimate_tokens"]
    - path: "mcp/src/extraction/feedback.rs"
      provides: "build_validation_feedback function"
      exports: ["build_validation_feedback"]
    - path: "mcp/src/extraction/config.rs"
      provides: "ExtractionConfig struct with builder methods"
      exports: ["ExtractionConfig"]
  key_links:
    - from: "mcp/src/extraction/error.rs"
      to: "mcp/src/extraction/metrics.rs"
      via: "ExtractionError::MaxRetriesExceeded contains ExtractionMetrics"
      pattern: "metrics:\\s*ExtractionMetrics"
    - from: "mcp/src/extraction/feedback.rs"
      to: "jsonschema::Validator"
      via: "iter_errors for complete validation error collection"
      pattern: "iter_errors"
---

<objective>
Create the foundation types for the extraction retry/validation system: error enums, metrics tracking, attempt records, configuration, validation feedback builder, and token estimation.

Purpose: These types are consumed by the extraction orchestrator (Plan 02) and define the contracts for retry behavior, error reporting, and cost tracking. Getting the type design right here means the orchestrator can focus purely on async control flow.

Output: `mcp/src/extraction/` module with error.rs, metrics.rs, feedback.rs, config.rs -- all compiling cleanly with `cargo check -p rig-mcp-server`.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-retry-validation-loop/02-CONTEXT.md
@.planning/phases/02-retry-validation-loop/02-RESEARCH.md
@mcp/src/lib.rs
@mcp/src/tools.rs
@mcp/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extraction module with error types, metrics, and config</name>
  <files>
    mcp/src/extraction/mod.rs
    mcp/src/extraction/error.rs
    mcp/src/extraction/metrics.rs
    mcp/src/extraction/config.rs
  </files>
  <action>
Create directory `mcp/src/extraction/` and add the following files:

**error.rs** - Typed error enum with attempt history:
- `ExtractionError` enum using `thiserror::Error` with these variants:
  - `MaxRetriesExceeded { attempts: usize, max_attempts: usize, history: Vec<AttemptRecord>, raw_output: String, metrics: ExtractionMetrics }` -- the primary failure mode
  - `ParseError { message: String, raw_text: String, attempt: usize }` -- JSON couldn't be parsed from agent output
  - `SchemaError(String)` -- jsonschema::Validator construction failed (invalid schema)
  - `AgentError(String)` -- the agent execution itself failed (CLI error, timeout, etc.)
  - `CallbackRejection { reason: String, attempt: usize }` -- on_submit callback returned Err
- `AttemptRecord` struct (Debug, Clone): `attempt_number: usize`, `submitted_json: serde_json::Value`, `validation_errors: Vec<String>`, `raw_agent_output: String`, `elapsed: std::time::Duration`
- All types must derive Debug. ExtractionError must implement std::error::Error via thiserror.
- Import ExtractionMetrics from sibling metrics module.

**metrics.rs** - Metrics tracking and token estimation:
- `ExtractionMetrics` struct (Debug, Clone): `total_attempts: usize`, `wall_time: std::time::Duration`, `estimated_input_tokens: usize`, `estimated_output_tokens: usize`
- `estimate_tokens(text: &str) -> usize` public function: use `text.chars().count() / 4` (ceiling division). Use `chars().count()` NOT `len()` to handle UTF-8 correctly per CONTEXT.md decision. Return `(text.chars().count() + 3) / 4` for ceiling division without floats.
- Implement Default for ExtractionMetrics (all zeros).

**config.rs** - Extraction configuration:
- `ExtractionConfig` struct (Debug, Clone): `max_attempts: usize` (default 3), `include_schema_in_feedback: bool` (default true)
- Implement Default with the above defaults.
- Builder methods: `pub fn with_max_attempts(mut self, max: usize) -> Self` and `pub fn with_schema_in_feedback(mut self, include: bool) -> Self`.

**mod.rs** - Module declarations:
- Declare `pub mod error;`, `pub mod metrics;`, `pub mod feedback;`, `pub mod config;`
- Re-export key types: `pub use error::{ExtractionError, AttemptRecord};`, `pub use metrics::{ExtractionMetrics, estimate_tokens};`, `pub use config::ExtractionConfig;`, `pub use feedback::build_validation_feedback;`
- Note: feedback module created in Task 2, but declare it here now (it will compile once Task 2 creates it).

Follow project conventions:
- Use `thiserror::Error` derive for error types
- Use `///` doc comments on all public items
- Do NOT use `.unwrap()` or `.expect()` -- these trigger clippy warnings in this workspace
- Use `#[must_use]` on builder methods that return Self
  </action>
  <verify>
Run `cargo check -p rig-mcp-server 2>&1` -- should show errors only about missing `feedback` module (created in Task 2), NOT about error.rs/metrics.rs/config.rs types. Temporarily comment out `pub mod feedback;` and the feedback re-export in mod.rs to verify the other three modules compile cleanly, then uncomment.
  </verify>
  <done>
ExtractionError, AttemptRecord, ExtractionMetrics, estimate_tokens, and ExtractionConfig all compile. ExtractionError::MaxRetriesExceeded contains ExtractionMetrics. Token estimation uses chars().count() not bytes len.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create validation feedback builder with rich error formatting</name>
  <files>
    mcp/src/extraction/feedback.rs
    mcp/src/lib.rs
  </files>
  <action>
**feedback.rs** - Validation feedback builder:

Create `pub fn build_validation_feedback(schema: &serde_json::Value, instance: &serde_json::Value, errors: &[String], attempt: usize, max_attempts: usize) -> String` that builds a feedback string for the agent:

Format (all parts mandatory per CONTEXT.md decisions):
```
Attempt {attempt}/{max_attempts}: JSON validation failed.

Errors:
  - {error1}
  - {error2}
  ...

Expected schema:
{pretty-printed schema JSON}

Your submission:
{pretty-printed instance JSON}

Please fix all errors and resubmit.
```

Also create `pub fn collect_validation_errors(schema: &serde_json::Value, instance: &serde_json::Value) -> Vec<String>` that:
1. Creates a `jsonschema::Validator` from the schema
2. Calls `validator.iter_errors(instance)` to get ALL errors (not just first)
3. Maps each error to `format!("At path '{}': {}", error.instance_path, error)`
4. Returns the Vec<String>
5. If Validator construction fails, return a single-element vec with the schema error message

Also create `pub fn build_parse_error_feedback(raw_text: &str, parse_error: &str, attempt: usize, max_attempts: usize, schema: &serde_json::Value) -> String` for JSON parse failures:
```
Attempt {attempt}/{max_attempts}: Could not parse your response as JSON.

Parse error: {parse_error}

Your response (first 500 chars):
{truncated raw_text}

Expected schema:
{pretty-printed schema JSON}

Please respond with valid JSON matching the schema above.
```

Truncate raw_text to first 500 chars to avoid bloating the feedback.

**lib.rs** - Update to expose extraction module:
Add `pub mod extraction;` to mcp/src/lib.rs.
Add `pub use crate::extraction::{ExtractionConfig, ExtractionError, ExtractionMetrics};` to the prelude module.

Follow conventions:
- All functions get `///` doc comments
- Use `serde_json::to_string_pretty()` which returns Result -- handle the error by falling back to `instance.to_string()` (compact format) if pretty-print fails. Use `.unwrap_or_else(|_| value.to_string())` pattern.
- Do NOT use `.unwrap()` or `.expect()`
  </action>
  <verify>
Run `cargo check -p rig-mcp-server 2>&1` -- should compile with zero errors. Run `cargo clippy -p rig-mcp-server -- -W clippy::pedantic 2>&1` -- should produce no new warnings (existing missing-docs warnings are acceptable).
  </verify>
  <done>
Full extraction module compiles. build_validation_feedback produces feedback with schema, submission echo, all errors, and attempt counter. collect_validation_errors uses iter_errors() for complete error collection. lib.rs exports extraction module and key types in prelude. `cargo check -p rig-mcp-server` passes.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p rig-mcp-server` compiles with zero errors
2. `cargo clippy -p rig-mcp-server -- -W clippy::pedantic` produces no new warnings
3. All types are accessible via `rig_mcp_server::extraction::*` and key types via `rig_mcp_server::prelude::*`
4. ExtractionError variants match CONTEXT.md decisions (MaxRetriesExceeded with history, raw_output, metrics)
5. Token estimation uses `chars().count()` not `len()`
</verification>

<success_criteria>
- All 5 extraction module files exist and compile
- ExtractionError has 5 variants: MaxRetriesExceeded, ParseError, SchemaError, AgentError, CallbackRejection
- ExtractionMetrics tracks attempts, wall_time, estimated_input_tokens, estimated_output_tokens
- ExtractionConfig defaults to max_attempts=3, include_schema_in_feedback=true
- build_validation_feedback includes schema + echoed submission + all errors + attempt counter
- collect_validation_errors uses iter_errors() for complete error list
- estimate_tokens uses chars().count() / 4 ceiling division
- `cargo check -p rig-mcp-server` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-retry-validation-loop/02-01-SUMMARY.md`
</output>
