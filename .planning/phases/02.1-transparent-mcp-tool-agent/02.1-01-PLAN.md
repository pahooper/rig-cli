---
phase: 02.1-transparent-mcp-tool-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - codex-adapter/src/types.rs
  - codex-adapter/src/cmd.rs
  - codex-adapter/src/process.rs
  - opencode-adapter/src/types.rs
  - opencode-adapter/src/cmd.rs
  - opencode-adapter/src/process.rs
autonomous: true

must_haves:
  truths:
    - "CodexConfig has mcp_config_path, system_prompt, and env_vars fields"
    - "OpenCodeConfig has mcp_config_path and env_vars fields"
    - "Codex subprocess receives environment variables from CodexConfig.env_vars"
    - "OpenCode subprocess receives environment variables from OpenCodeConfig.env_vars"
    - "Codex cmd.rs wires system_prompt to --system-prompt flag"
    - "OpenCode cmd.rs wires system_prompt (which already exists) to --system-prompt flag"
  artifacts:
    - path: "codex-adapter/src/types.rs"
      provides: "CodexConfig with MCP config path, system_prompt, and env_vars"
      contains: "mcp_config_path"
    - path: "codex-adapter/src/cmd.rs"
      provides: "CLI args for system prompt"
      contains: "system_prompt"
    - path: "codex-adapter/src/process.rs"
      provides: "Env var injection into Codex child process"
      contains: "env_vars"
    - path: "opencode-adapter/src/types.rs"
      provides: "OpenCodeConfig with env_vars field"
      contains: "env_vars"
    - path: "opencode-adapter/src/cmd.rs"
      provides: "System prompt wired to --system-prompt flag"
      contains: "system_prompt"
    - path: "opencode-adapter/src/process.rs"
      provides: "Env var injection into OpenCode child process"
      contains: "env_vars"
  key_links:
    - from: "codex-adapter/src/types.rs"
      to: "codex-adapter/src/cmd.rs"
      via: "New config fields used in build_args"
      pattern: "config\\.system_prompt"
    - from: "codex-adapter/src/types.rs"
      to: "codex-adapter/src/process.rs"
      via: "env_vars passed to Command::env in spawn_child"
      pattern: "config\\.env_vars"
    - from: "opencode-adapter/src/types.rs"
      to: "opencode-adapter/src/process.rs"
      via: "env_vars passed to Command::env in spawn_child"
      pattern: "config\\.env_vars"
---

<objective>
Add MCP-related configuration fields to the Codex and OpenCode adapter crates so McpToolAgent can deliver MCP config, environment variables, and system prompts to these CLIs.

Purpose: The claudecode-adapter already has full MCP support (RunConfig.mcp, .tools, .env, .system_prompt). The other two adapters are missing these fields entirely. Without them, McpToolAgent cannot generate adapter-specific configs. This plan closes that gap.

Output: Updated CodexConfig and OpenCodeConfig structs with MCP fields, wired through cmd.rs and process.rs. Both adapters can now receive environment variables and MCP-related configuration from callers.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-transparent-mcp-tool-agent/02.1-RESEARCH.md

@codex-adapter/src/types.rs
@codex-adapter/src/cmd.rs
@codex-adapter/src/process.rs
@codex-adapter/src/lib.rs
@opencode-adapter/src/types.rs
@opencode-adapter/src/cmd.rs
@opencode-adapter/src/process.rs
@opencode-adapter/src/lib.rs
@claudecode-adapter/src/types.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP config fields to codex-adapter</name>
  <files>
    codex-adapter/src/types.rs
    codex-adapter/src/cmd.rs
    codex-adapter/src/process.rs
  </files>
  <action>
Add three new fields to CodexConfig in types.rs:

1. `pub system_prompt: Option<String>` -- System prompt override. Doc comment: "/// System prompt to append to the agent's instructions."
2. `pub env_vars: Vec<(String, String)>` -- Environment variables for the subprocess. Doc comment: "/// Extra environment variables passed to the subprocess."
3. `pub mcp_config_path: Option<std::path::PathBuf>` -- Path to MCP config file (used by McpToolAgent to pass temp config). Doc comment: "/// Path to an MCP configuration file (TOML format for Codex)."

Default values in impl Default: system_prompt: None, env_vars: Vec::new(), mcp_config_path: None.

In cmd.rs build_args(), add BEFORE the final prompt argument push:
- If config.system_prompt is Some(ref sp): push "--system-prompt" then push the system prompt value. Note: Codex CLI uses `codex exec --system-prompt "..."` for system prompt injection.
- If config.mcp_config_path is Some(ref path): The Codex CLI reads MCP config from its config.toml. The McpToolAgent will handle writing the TOML and setting it via the config dir mechanism OR via --config overrides. For now, if mcp_config_path is set, add `--config` override: push "--config", then push format!("mcp_servers_config={}", path.to_string_lossy()). ACTUALLY -- Codex does NOT have a --mcp-config flag. The MCP config must be in config.toml. The way McpToolAgent will handle this is by writing a temp config.toml and using env vars or config overrides. For the adapter layer, just make the field available. Do NOT add any CLI args for mcp_config_path -- McpToolAgent will handle this at a higher level by writing the TOML and potentially manipulating the config dir. The adapter just needs to carry the data.

In process.rs spawn_child() function, after setting current_dir, add environment variable injection (same pattern as claudecode-adapter/src/process.rs lines 84-86):
```rust
for (k, v) in &config.env_vars {
    cmd.env(k, v);
}
```

The spawn_child function signature currently takes `(path, args, cwd)`. It needs access to config.env_vars. Change the signature to accept the full CodexConfig reference instead of just cwd:
- Change `fn spawn_child(path: &std::path::Path, args: &[std::ffi::OsString], cwd: Option<&std::path::Path>)` to `fn spawn_child(path: &std::path::Path, args: &[std::ffi::OsString], config: &CodexConfig)`
- Inside, use `config.cd.as_deref()` instead of the cwd parameter
- Add the env_vars loop after current_dir
- Update the caller in run_codex() to pass config instead of config.cd.as_deref()

IMPORTANT: All public items need doc comments (crate uses workspace lints). Ensure the new fields have `///` doc comments.
  </action>
  <verify>
Run `cargo check -p codex-adapter 2>&1` -- must compile with zero errors. Verify no clippy warnings with `cargo clippy -p codex-adapter 2>&1`.
  </verify>
  <done>
CodexConfig has system_prompt, env_vars, and mcp_config_path fields. system_prompt is wired to --system-prompt CLI flag. env_vars are injected into the subprocess via Command::env(). mcp_config_path is stored but not directly wired to CLI args (McpToolAgent handles Codex MCP config delivery). codex-adapter compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MCP config fields to opencode-adapter</name>
  <files>
    opencode-adapter/src/types.rs
    opencode-adapter/src/cmd.rs
    opencode-adapter/src/process.rs
  </files>
  <action>
Add two new fields to OpenCodeConfig in types.rs:

1. `pub env_vars: Vec<(String, String)>` -- Environment variables for the subprocess. Doc comment: "/// Extra environment variables passed to the subprocess." This is critical because OpenCode uses OPENCODE_CONFIG env var to point to a custom config file.
2. `pub mcp_config_path: Option<std::path::PathBuf>` -- Path to MCP config file. Doc comment: "/// Path to an MCP configuration JSON file (OpenCode format)."

Note: OpenCodeConfig already has `pub prompt: Option<String>` (system prompt) but it is NOT wired in cmd.rs. Wire it now.

Default values in impl Default: env_vars: Vec::new(), mcp_config_path: None (prompt already defaults to None).

In cmd.rs build_args(), add BEFORE the final message argument push:
- If config.prompt is Some(ref p): push "--system-prompt" then push the prompt value. (OpenCode CLI uses `opencode run --system-prompt "..."` for system prompt injection.)

In process.rs spawn_child() function, add environment variable injection after the current_dir block. The spawn_child function currently takes `(path, message, config)` and already has access to the full config. Add after `cmd.current_dir(cwd)`:
```rust
for (k, v) in &config.env_vars {
    cmd.env(k, v);
}
```

Also: If config.mcp_config_path is set, automatically add the OPENCODE_CONFIG env var pointing to it. Add after the env_vars loop:
```rust
if let Some(ref mcp_path) = config.mcp_config_path {
    cmd.env("OPENCODE_CONFIG", mcp_path);
}
```

This way, when McpToolAgent writes an opencode.json temp file with MCP config, it can set mcp_config_path on OpenCodeConfig and the adapter will automatically point OpenCode to it via the OPENCODE_CONFIG env var.

IMPORTANT: All public items need doc comments. Ensure new fields have `///` doc comments.
  </action>
  <verify>
Run `cargo check -p opencode-adapter 2>&1` -- must compile with zero errors. Run `cargo clippy -p opencode-adapter 2>&1` -- no new warnings. Verify env_vars loop and OPENCODE_CONFIG env var are present in process.rs.
  </verify>
  <done>
OpenCodeConfig has env_vars and mcp_config_path fields. env_vars are injected into subprocess. mcp_config_path automatically sets OPENCODE_CONFIG env var on the child process. prompt field (system prompt) is now wired to --system-prompt CLI flag. opencode-adapter compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cargo check -p codex-adapter` passes with zero errors
2. `cargo check -p opencode-adapter` passes with zero errors
3. `cargo check --workspace` passes (no downstream breakage from new fields with defaults)
4. CodexConfig has system_prompt, env_vars, mcp_config_path fields
5. OpenCodeConfig has env_vars, mcp_config_path fields
6. Both adapters inject env_vars into subprocess via Command::env()
7. OpenCode adapter auto-sets OPENCODE_CONFIG when mcp_config_path is provided
8. No .unwrap() or .expect() in new code
</verification>

<success_criteria>
- CodexConfig and OpenCodeConfig have all fields needed for McpToolAgent to deliver MCP config
- Both adapters support environment variable injection on child processes
- OpenCode adapter automatically uses OPENCODE_CONFIG env var for MCP config delivery
- System prompts are wired to CLI flags in both adapters
- Full workspace compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-transparent-mcp-tool-agent/02.1-01-SUMMARY.md`
</output>
