---
phase: 06-platform-hardening
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - justfile
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Running 'just audit' executes cargo audit and reports results"
    - "Running 'just outdated' shows outdated root dependencies"
    - "The check recipe includes cargo audit (not commented out)"
    - "No critical or high CVEs exist in current dependencies (or documented as accepted)"
    - "All workspace dependencies use caret requirements (default semver strategy)"
  artifacts:
    - path: "justfile"
      provides: "audit, audit-update, and outdated targets"
      contains: "cargo audit"
  key_links:
    - from: "justfile"
      to: "cargo-audit"
      via: "just audit target runs cargo audit"
      pattern: "cargo audit"
---

<objective>
Add dependency audit infrastructure to the justfile and verify all current dependencies are healthy and using appropriate semver strategies.

Purpose: PLAT-05 requires external crate dependencies are well-maintained and stable. This plan adds `cargo audit` and `cargo outdated` as justfile targets, runs them against current dependencies, and verifies no critical/high CVEs exist. Per user decision: no GitHub Actions, justfile targets only.

Output: Updated justfile with audit/outdated targets, documented dependency health status.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-platform-hardening/06-RESEARCH.md

@justfile
@Cargo.toml
@Cargo.lock
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add audit targets to justfile and verify dependency health</name>
  <files>justfile</files>
  <action>
  **Step 1: Update justfile with audit targets**

  Replace the current justfile content with an expanded version that includes the audit targets. Keep the existing `check`, `fmt`, and `test` recipes and add new ones:

  ```just
  check:
    cargo fmt --all -- --check
    cargo clippy --all-targets --all-features -- -D warnings
    cargo test --all-features
    cargo audit

  fmt:
    cargo fmt --all

  test:
    cargo test --all-features

  # Scan dependencies for known vulnerabilities (RustSec Advisory Database)
  audit:
    cargo audit

  # Update the advisory database and scan
  audit-update:
    cargo audit fetch && cargo audit

  # Show outdated root dependencies
  outdated:
    cargo outdated --root-deps-only
  ```

  Key changes from the existing justfile:
  - Uncomment `cargo audit` in the `check` recipe (was commented out as `# cargo audit`)
  - Remove the other commented-out tools (`cargo deny check`, `cargo machete`, `typos`) — they can be re-added when installed, but the comments were just noise
  - Add standalone `audit`, `audit-update`, and `outdated` recipes

  **Step 2: Verify cargo-audit is installed**

  Run `cargo audit --version` to check if it's installed. If not, install it:
  ```bash
  cargo install cargo-audit
  ```

  **Step 3: Run cargo audit**

  Run `cargo audit` and evaluate the results:
  - **Critical/High CVEs:** Must be resolved or documented as accepted with rationale
  - **Medium CVEs:** Warn and document, schedule fix
  - **Low CVEs:** Note and ignore

  If any critical/high CVEs are found:
  1. Check if a patched version exists (`cargo audit fix --dry-run`)
  2. If a patched version exists, update the dependency in the relevant Cargo.toml
  3. If no patched version exists, document the CVE in a code comment near the dependency declaration

  **Step 4: Verify semver strategy**

  Read the workspace Cargo.toml and all member Cargo.toml files. Verify all dependencies use caret requirements (the default, e.g., `"1.0"` or `"^1.0"`). Flag any exact pins (`"=1.0.0"`) or wildcard (`"*"`) usage.

  Current dependencies to verify (from crate Cargo.toml files):
  - tokio "1.0" — caret, good
  - serde "1.0" — caret, good
  - serde_json "1.0" — caret, good
  - anyhow "1.0" — caret, good
  - thiserror "1.0" — caret, good
  - which "6.0" — caret, good
  - nix "0.29" — caret, good
  - tracing "0.1" — caret, good
  - tempfile "3.10" — caret, good
  - semver "1.0" — caret, good
  - rig-core "0.29.0" — caret (equivalent to ^0.29.0), good
  - rmcp dependencies in mcp/Cargo.toml — check

  All should be caret requirements. If any are exact-pinned, leave them unless there's a specific reason to change.

  **Step 5: Optionally check for outdated deps**

  If `cargo-outdated` is installed, run `cargo outdated --root-deps-only` to see if any direct dependencies have newer versions. This is informational only — don't update dependencies in this plan unless needed for CVE resolution.

  If cargo-outdated is not installed, note this and move on (it's optional tooling, not a blocker).
  </action>
  <verify>
  Run `just audit` to verify the target works and produces output.
  Run `just check` to verify the full check recipe works (including audit).
  Verify justfile contains uncommented `cargo audit` in the check recipe.
  Verify justfile contains standalone `audit`, `audit-update`, and `outdated` recipes.
  If any CVEs were found, verify they were resolved or documented.
  </verify>
  <done>
  justfile has audit, audit-update, and outdated targets.
  The check recipe includes cargo audit (not commented out).
  cargo audit ran successfully against current dependencies.
  No unaddressed critical/high CVEs in dependencies (or documented if present).
  All dependencies use caret semver requirements.
  </done>
</task>

</tasks>

<verification>
1. `just audit` runs successfully
2. `just check` includes `cargo audit` in its pipeline
3. justfile has `audit`, `audit-update`, `outdated` recipes
4. No critical/high CVEs in `cargo audit` output (or documented)
5. All dependencies use caret requirements (no exact pins, no wildcards)
</verification>

<success_criteria>
- Dependency audit is part of the standard check workflow
- cargo audit runs cleanly (no critical/high CVEs)
- Developers can run `just audit` for standalone vulnerability scanning
- Semver strategy is consistent (caret requirements throughout)
- No GitHub Actions — justfile targets only (per user decision)
</success_criteria>

<output>
After completion, create `.planning/phases/06-platform-hardening/06-04-SUMMARY.md`
</output>
