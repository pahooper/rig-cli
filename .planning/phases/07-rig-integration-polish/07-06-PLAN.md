---
phase: 07-rig-integration-polish
plan: 06
type: execute
wave: 2
depends_on: ["07-05"]
files_modified:
  - rig-cli/src/claude.rs
  - rig-cli/src/codex.rs
  - rig-cli/src/opencode.rs
  - rig-cli/src/lib.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "client.mcp_agent(\"model\") returns CliAgentBuilder preconfigured with CliAdapter::ClaudeCode (for Claude)"
    - "client.mcp_agent(\"model\") returns CliAgentBuilder preconfigured with CliAdapter::Codex (for Codex)"
    - "client.mcp_agent(\"model\") returns CliAgentBuilder preconfigured with CliAdapter::OpenCode (for OpenCode)"
    - "CliAgentBuilder.build() returns CliAgent that implements Prompt and Chat traits"
    - "CliAgent streams via prompt_stream() method returning Receiver<McpStreamEvent>"
    - "Two paths are clearly documented: agent() for simple/direct CLI, mcp_agent() for MCP-enforced extraction"
  artifacts:
    - path: "rig-cli/src/claude.rs"
      provides: "Claude Client with mcp_agent() method"
      contains: "pub fn mcp_agent"
    - path: "rig-cli/src/codex.rs"
      provides: "Codex Client with mcp_agent() method"
      contains: "pub fn mcp_agent"
    - path: "rig-cli/src/opencode.rs"
      provides: "OpenCode Client with mcp_agent() method"
      contains: "pub fn mcp_agent"
    - path: "rig-cli/src/lib.rs"
      provides: "Re-exports CliAgent, CliAgentBuilder, McpStreamEvent from rig-provider"
      contains: "CliAgent"
  key_links:
    - from: "rig-cli/src/claude.rs"
      to: "rig_provider::mcp_agent::CliAgentBuilder"
      via: "mcp_agent() returns CliAgentBuilder::new().adapter(CliAdapter::ClaudeCode)"
      pattern: "CliAdapter::ClaudeCode"
    - from: "rig-cli/src/codex.rs"
      to: "rig_provider::mcp_agent::CliAgentBuilder"
      via: "mcp_agent() returns CliAgentBuilder::new().adapter(CliAdapter::Codex)"
      pattern: "CliAdapter::Codex"
    - from: "rig-cli/src/opencode.rs"
      to: "rig_provider::mcp_agent::CliAgentBuilder"
      via: "mcp_agent() returns CliAgentBuilder::new().adapter(CliAdapter::OpenCode)"
      pattern: "CliAdapter::OpenCode"
---

<objective>
Add mcp_agent() method to each Client in rig-cli that returns a CliAgentBuilder preconfigured with the appropriate adapter.

Purpose: Users need TWO paths:
1. `client.agent("model")` - Standard Rig Agent path, direct CLI execution, simple prompts
2. `client.mcp_agent("model")` - MCP-enforced CliAgent path, structured extraction, streaming

This plan wires the CliAgent (from 07-05) into the rig-cli facade so users can access MCP enforcement through the familiar Client interface.

Output: All three Client types (Claude, Codex, OpenCode) have mcp_agent() method returning CliAgentBuilder. Documentation clearly explains the two paths.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-rig-integration-polish/07-05-PLAN.md (depends on this completing first)

Key existing code to reference:
@rig-cli/src/claude.rs (current Client with agent() from CompletionClient)
@rig-cli/src/codex.rs (current Client)
@rig-cli/src/opencode.rs (current Client)
@rig-cli/src/lib.rs (current re-exports)
@rig-provider/src/mcp_agent.rs (CliAgent, CliAgentBuilder, CliAdapter from 07-05)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mcp_agent() to Claude Client and update docs</name>
  <files>rig-cli/src/claude.rs</files>
  <action>
Add mcp_agent() method to Claude Client and update documentation to clearly describe the two paths.

**1. Add mcp_agent() method to Client:**

```rust
use rig_provider::mcp_agent::{CliAdapter, CliAgentBuilder};

impl Client {
    // ... existing methods ...

    /// Creates an MCP-enforced agent builder for structured extraction.
    ///
    /// Unlike [`agent()`](rig::client::CompletionClient::agent) which uses direct CLI execution,
    /// `mcp_agent()` routes ALL interactions through the MCP server, ensuring the agent
    /// can ONLY respond via MCP tool calls. This enforces structured output extraction.
    ///
    /// # Two Execution Paths
    ///
    /// | Method | Path | Use Case |
    /// |--------|------|----------|
    /// | `client.agent("model")` | Direct CLI | Simple prompts, chat, streaming |
    /// | `client.mcp_agent("model")` | MCP Server | Structured extraction, forced tool use |
    ///
    /// # Example
    ///
    /// ```no_run
    /// # use rig_cli::claude::Client;
    /// # use rig::completion::Prompt;
    /// # async fn example() -> Result<(), Box<dyn std::error::Error>> {
    /// let client = Client::new().await?;
    ///
    /// // MCP-enforced extraction
    /// let agent = client.mcp_agent("sonnet")
    ///     .toolset(extraction_tools)
    ///     .preamble("You are a data extraction agent")
    ///     .build()?;
    ///
    /// let result = agent.prompt("Extract user data from: ...").await?;
    /// # Ok(())
    /// # }
    /// ```
    #[must_use]
    pub fn mcp_agent(&self, _model: impl Into<String>) -> CliAgentBuilder {
        let mut builder = CliAgentBuilder::new()
            .adapter(CliAdapter::ClaudeCode)
            .timeout(self.config.timeout);

        // Transfer payload if set on client
        if let Some(ref payload) = self.payload {
            builder = builder.payload(payload.clone());
        }

        builder
    }
}
```

**2. Update module-level documentation:**

Replace the current doc comment (lines 1-27) with:

```rust
//! Claude Code provider with CompletionModel and MCP-enforced CliAgent.
//!
//! This module provides two execution paths for the Claude Code CLI:
//!
//! | Method | Execution | Use Case |
//! |--------|-----------|----------|
//! | `client.agent("model")` | Direct CLI | Simple prompts, chat, streaming |
//! | `client.mcp_agent("model")` | MCP Server | Structured extraction, forced tool use |
//!
//! # Simple Prompts (Direct CLI)
//!
//! ```no_run
//! # use rig_cli::claude::Client;
//! # use rig::client::CompletionClient;
//! # use rig::completion::Prompt;
//! # async fn example() -> Result<(), Box<dyn std::error::Error>> {
//! let client = Client::new().await?;
//! let agent = client.agent("claude-sonnet-4")
//!     .preamble("You are a helpful assistant")
//!     .build();
//! let response = agent.prompt("Hello!").await?;
//! # Ok(())
//! # }
//! ```
//!
//! # Structured Extraction (MCP-Enforced)
//!
//! ```no_run
//! # use rig_cli::claude::Client;
//! # use rig::completion::Prompt;
//! # async fn example() -> Result<(), Box<dyn std::error::Error>> {
//! let client = Client::new().await?;
//! let agent = client.mcp_agent("sonnet")
//!     .toolset(extraction_tools)
//!     .preamble("Extract structured data")
//!     .build()?;
//! let result = agent.prompt("Extract from: ...").await?;
//! # Ok(())
//! # }
//! ```
//!
//! For MCP enforcement, the agent is constrained to submit responses ONLY via
//! MCP tool calls, preventing freeform text responses and ensuring schema compliance.
```

**3. Update Client struct documentation:**

Replace the "MCP Enforcement" section (lines 73-77) with:

```rust
/// # Execution Paths
///
/// - `client.agent("model")` - Returns Rig's `AgentBuilder` for direct CLI execution.
///   Use for simple prompts and chat where structured output is not required.
///
/// - `client.mcp_agent("model")` - Returns `CliAgentBuilder` for MCP-enforced execution.
///   Use for structured extraction where the agent MUST respond via tool calls.
```

**4. Update Model struct documentation:**

Replace lines 203-209 with:

```rust
/// The CompletionModel implementation for Claude Code.
///
/// Provides direct CLI execution for prompts and streaming. For MCP-enforced
/// structured extraction, use `Client::mcp_agent()` instead.
///
/// Users interact with this via `AgentBuilder` (from `client.agent()`), not directly.
```

**5. Remove misleading completion_with_mcp and completion_without_mcp methods:**

The completion() method should be simplified to a single direct CLI path (like codex.rs currently has). Remove:
- completion_with_mcp() method (lines 336-352)
- completion_without_mcp() method (lines 354-404)
- The if/else routing in completion() (lines 247-254)

Replace with a single direct implementation similar to what completion_without_mcp() currently does.

**6. Add import for CliAgentBuilder and CliAdapter at top of file:**

```rust
use rig_provider::mcp_agent::{CliAdapter, CliAgentBuilder};
```

**What NOT to do:**
- Do NOT remove the existing CompletionClient implementation (agent() method)
- Do NOT change the streaming implementation
- Do NOT try to route completion() through McpToolAgent (architecturally impossible)
  </action>
  <verify>
Run `cargo check -p rig-cli 2>&1 | grep -E "^error"` - should return no errors.
Run `grep -n "pub fn mcp_agent" rig-cli/src/claude.rs` - should match.
Run `grep -n "CliAdapter::ClaudeCode" rig-cli/src/claude.rs` - should match.
Run `grep -n "completion_with_mcp\|completion_without_mcp" rig-cli/src/claude.rs` - should return no matches.
  </verify>
  <done>
Claude Client has mcp_agent() method returning CliAgentBuilder preconfigured with CliAdapter::ClaudeCode. Documentation clearly explains the two execution paths. Misleading MCP routing code removed from completion().
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mcp_agent() to Codex, OpenCode Clients and update lib.rs</name>
  <files>rig-cli/src/codex.rs, rig-cli/src/opencode.rs, rig-cli/src/lib.rs</files>
  <action>
Apply the same mcp_agent() pattern to Codex and OpenCode clients, and update lib.rs re-exports.

**For rig-cli/src/codex.rs:**

1. Add import at top:
```rust
use rig_provider::mcp_agent::{CliAdapter, CliAgentBuilder};
```

2. Add mcp_agent() method to Client (same pattern as Claude but with CliAdapter::Codex):
```rust
impl Client {
    /// Creates an MCP-enforced agent builder for structured extraction.
    ///
    /// See module docs for the difference between `agent()` and `mcp_agent()`.
    #[must_use]
    pub fn mcp_agent(&self, _model: impl Into<String>) -> CliAgentBuilder {
        let mut builder = CliAgentBuilder::new()
            .adapter(CliAdapter::Codex)
            .timeout(self.config.timeout);

        if let Some(ref payload) = self.payload {
            builder = builder.payload(payload.clone());
        }

        builder
    }
}
```

3. Update module-level documentation (lines 1-25):
```rust
//! Codex provider client with CompletionModel and MCP-enforced CliAgent.
//!
//! This module provides two execution paths:
//!
//! | Method | Execution | Use Case |
//! |--------|-----------|----------|
//! | `client.agent("model")` | Direct CLI | Simple prompts, chat, streaming |
//! | `client.mcp_agent("model")` | MCP Server | Structured extraction, forced tool use |
//!
//! ## Example
//!
//! ```no_run
//! # async fn example() -> Result<(), Box<dyn std::error::Error>> {
//! let client = rig_cli::codex::Client::new().await?;
//! let agent = client.agent("gpt-4").preamble("You are helpful").build();
//! let response = agent.prompt("Hello!").await?;
//! # Ok(())
//! # }
//! ```
```

4. Remove the TODO comment at lines 156-158.

5. Update Model struct doc to remove "routing tool-bearing requests through McpToolAgent" language.

**For rig-cli/src/opencode.rs:**

Apply identical changes as codex.rs, but with CliAdapter::OpenCode.

**For rig-cli/src/lib.rs:**

1. Add re-exports for CliAgent types:
```rust
// MCP-enforced agent types (from rig-provider)
pub use rig_provider::mcp_agent::{CliAgent, CliAgentBuilder, CliAdapter, McpStreamEvent};
```

2. Update crate-level documentation to explain the two paths:

After the Quick Start section, add:

```rust
//! ## Two Execution Paths
//!
//! rig-cli provides two ways to interact with CLI agents:
//!
//! | Method | When to Use |
//! |--------|-------------|
//! | `client.agent("model")` | Simple prompts, chat, streaming - direct CLI execution |
//! | `client.mcp_agent("model")` | Structured extraction - MCP-enforced tool use |
//!
//! For structured data extraction where the agent MUST respond via tool calls
//! (not freeform text), use `mcp_agent()`:
//!
//! ```no_run
//! # async fn example() -> Result<(), Box<dyn std::error::Error>> {
//! let client = rig_cli::claude::Client::new().await?;
//! let agent = client.mcp_agent("sonnet")
//!     .toolset(my_tools)
//!     .build()?;
//! let result = agent.prompt("Extract data...").await?;
//! # Ok(())
//! # }
//! ```
```

**What NOT to do:**
- Do NOT change the CompletionClient implementations
- Do NOT remove or change existing streaming implementations
- Do NOT try to implement MCP routing in completion() methods
  </action>
  <verify>
Run `cargo check -p rig-cli 2>&1 | grep -E "^error"` - should return no errors.
Run `grep -n "pub fn mcp_agent" rig-cli/src/codex.rs rig-cli/src/opencode.rs` - should match both files.
Run `grep -n "CliAdapter::Codex" rig-cli/src/codex.rs` - should match.
Run `grep -n "CliAdapter::OpenCode" rig-cli/src/opencode.rs` - should match.
Run `grep -n "TODO.*MCP\|TODO.*McpToolAgent" rig-cli/src/codex.rs rig-cli/src/opencode.rs` - should return no matches.
Run `grep -n "CliAgent" rig-cli/src/lib.rs` - should show re-export.
  </verify>
  <done>
Codex and OpenCode Clients have mcp_agent() methods returning CliAgentBuilder with appropriate adapters. lib.rs re-exports CliAgent, CliAgentBuilder, CliAdapter, McpStreamEvent. All TODO comments about MCP routing removed. Documentation updated.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `cargo check -p rig-cli` - compiles without errors
2. `cargo test -p rig-cli` - all tests pass
3. `grep -c "pub fn mcp_agent" rig-cli/src/claude.rs rig-cli/src/codex.rs rig-cli/src/opencode.rs` - returns 1 for each file
4. `grep -rn "completion_with_mcp\|completion_without_mcp" rig-cli/src/` - no matches
5. `grep -rn "TODO.*MCP" rig-cli/src/` - no matches
6. `grep -n "CliAgent\|CliAgentBuilder" rig-cli/src/lib.rs` - shows re-exports
</verification>

<success_criteria>
- All three Clients (Claude, Codex, OpenCode) have mcp_agent() method
- mcp_agent() returns CliAgentBuilder preconfigured with correct CliAdapter variant
- Client payload is transferred to CliAgentBuilder if set
- No misleading completion_with_mcp / completion_without_mcp code remains
- No TODO comments about deferred MCP routing remain
- lib.rs re-exports CliAgent, CliAgentBuilder, CliAdapter, McpStreamEvent
- Documentation clearly explains agent() vs mcp_agent() paths
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-rig-integration-polish/07-06-SUMMARY.md`
</output>
