---
phase: 07-rig-integration-polish
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - rig-cli/src/claude.rs
autonomous: true

must_haves:
  truths:
    - "Developer can write: let client = rig_cli::claude::Client::new(); let agent = client.agent(\"sonnet\").preamble(\"...\").build();"
    - "Client::new() discovers Claude CLI binary and caches the result"
    - "client.agent() returns Rig's AgentBuilder which chains .preamble().tool().temperature().build()"
    - "client.extractor::<T>() returns Rig's ExtractorBuilder for structured extraction"
    - "Agent built from client.agent() implements Prompt trait — agent.prompt(\"...\").await works"
  artifacts:
    - path: "rig-cli/src/claude.rs"
      provides: "Claude Code provider client and CompletionClient implementation"
      min_lines: 60
      contains: "impl CompletionClient"
  key_links:
    - from: "rig-cli/src/claude.rs"
      to: "rig-provider/src/adapters/claude.rs"
      via: "wraps ClaudeModel"
      pattern: "ClaudeModel"
    - from: "rig-cli/src/claude.rs"
      to: "rig::client::CompletionClient"
      via: "trait implementation"
      pattern: "CompletionClient for Client"
---

<objective>
Implement the Claude Code client that makes CLI agents feel like native Rig providers.

Purpose: This is the reference implementation for the provider pattern. `rig_cli::claude::Client` wraps existing `ClaudeModel` behind Rig's `CompletionClient` trait, giving users the standard `client.agent("model").preamble("...").build()` chain. Codex and OpenCode will follow this exact pattern.
Output: `claude.rs` with Client struct implementing CompletionClient, giving access to .agent() and .extractor().
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-rig-integration-polish/07-CONTEXT.md
@.planning/phases/07-rig-integration-polish/07-RESEARCH.md
@.planning/phases/07-rig-integration-polish/07-01-SUMMARY.md
@rig-provider/src/adapters/claude.rs
@rig-provider/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Claude Client with CompletionClient trait</name>
  <files>rig-cli/src/claude.rs</files>
  <action>
Replace the placeholder `claude.rs` with the full Claude Code provider implementation.

**Study Rig's pattern first.** The key insight from reading rig-core 0.29 source:
- Rig's `CompletionClient` trait has two methods: `completion_model()` and `agent()` (with default impl that calls `completion_model()`)
- `CompletionClient` trait requires `type CompletionModel: CompletionModel<Client = Self>`
- The `CompletionModel` trait requires `fn make(client: &Self::Client, model: impl Into<String>) -> Self`
- So the CLI Client struct must be the `Client` associated type on `ClaudeModel`

**Problem:** Currently `ClaudeModel::Client = ClaudeCli`. We need `ClaudeModel::Client = rig_cli::claude::Client`. But we CANNOT change the existing `ClaudeModel` impl in rig-provider (it would break existing code).

**Solution:** Create a NEW CompletionModel wrapper type in rig-cli that delegates to the existing ClaudeModel but has `Client = rig_cli::claude::Client`.

Implementation:

```rust
//! Claude Code provider for Rig.
//!
//! # Example
//! ```no_run
//! use rig_cli::claude;
//! use rig::completion::Prompt;
//!
//! # async fn example() -> Result<(), Box<dyn std::error::Error>> {
//! let client = claude::Client::new().await?;
//! let agent = client.agent("sonnet").preamble("You are helpful").build();
//! let response = agent.prompt("Hello!").await?;
//! # Ok(())
//! # }
//! ```

use crate::config::ClientConfig;
use crate::errors::Error;
```

1. **Client struct:**
   ```rust
   #[derive(Clone)]
   pub struct Client {
       inner: rig_provider::ClaudeModel,
       config: ClientConfig,
   }
   ```
   - `inner` holds the already-discovered `ClaudeModel` (which contains `ClaudeCli`)
   - `config` holds CLI-specific settings

2. **Client constructors:**
   - `pub async fn new() -> Result<Self, Error>` — Discovers Claude CLI via `claudecode_adapter::init(None)`, creates ClaudeModel, wraps in Client with default config. If binary not found, return `Error::ClaudeNotFound`.
   - `pub async fn from_config(config: ClientConfig) -> Result<Self, Error>` — Same but uses config.binary_path if provided.
   - Mark both as `async` because CLI discovery requires filesystem checks. This is a known deviation from Rig's sync `Client::new()` — document it clearly. CLI agents require binary discovery which is inherently async.

3. **CompletionModel wrapper:**
   Create `pub struct Model` (or `CompletionModel` — but avoid name collision with Rig's trait):
   ```rust
   #[derive(Clone)]
   pub struct Model {
       inner: rig_provider::ClaudeModel,
   }
   ```
   Implement `rig::completion::CompletionModel for Model`:
   - `type Response = claudecode_adapter::RunResult;`
   - `type StreamingResponse = ();`
   - `type Client = Client;` — THIS is the key: Client is our wrapper
   - `fn make(client: &Client, model: impl Into<String>) -> Self` — Create Model from client.inner.cli (ignore model string since CLI agents don't select models this way, but accept it for API compatibility)
   - `async fn completion(...)` — Delegate to `self.inner.completion(request)`
   - `async fn stream(...)` — Delegate to `self.inner.stream(request)`

4. **CompletionClient implementation:**
   ```rust
   impl rig::client::CompletionClient for Client {
       type CompletionModel = Model;

       fn completion_model(&self, model: impl Into<String>) -> Model {
           Model::make(self, model)
       }
       // .agent() and .extractor() get default implementations automatically!
   }
   ```

5. **Convenience method:**
   - `Client::agent()` is already provided by the default impl on CompletionClient
   - But if we want to add CLI-specific builder methods, add them as extension methods later (Plan 04)

**Critical details:**
- The `model` parameter in `client.agent("sonnet")` is accepted for API compatibility but currently ignored — Claude CLI picks its own model. Document this in the doc comment: "The model parameter is accepted for API compatibility. Claude Code CLI uses its default model."
- Implement `Clone` for Client (required by CompletionClient trait system)
- Do NOT implement `ProviderClient` trait — it's tied to HTTP Client<Ext, H> machinery. Just implement `CompletionClient` directly.

**What NOT to do:**
- Do NOT try to implement Rig's `Provider` or `ProviderBuilder` traits — those are for HTTP-based providers
- Do NOT try to use Rig's `Client<Ext, H>` generic — CLI providers don't use HTTP
- Do NOT expose `ClaudeModel`, `ClaudeCli`, `RunConfig`, `McpToolAgent` in the public API
  </action>
  <verify>
Run `cargo check -p rig-cli` — should compile.
Write a brief compile-test in claude.rs (doc test or commented code) showing:
```rust
// let client = claude::Client::new().await?;
// let agent = client.agent("sonnet").preamble("...").build();
// let response = agent.prompt("Hello").await?;
```
Verify the type chain resolves: Client -> CompletionClient -> AgentBuilder -> Agent -> Prompt.
  </verify>
  <done>rig_cli::claude::Client exists, implements CompletionClient, client.agent("model").preamble("...").build() compiles, agent implements Prompt trait.</done>
</task>

</tasks>

<verification>
- `cargo check -p rig-cli --features claude` passes
- `rig_cli::claude::Client::new()` returns `Result<Client, Error>`
- `client.agent("model")` returns `AgentBuilder<Model>`
- `client.extractor::<T>("model")` returns `ExtractorBuilder<Model, T>`
- No internal types (ClaudeModel, RunConfig, McpToolAgent) appear in public API
</verification>

<success_criteria>
- Claude Client compiles and provides the standard Rig provider pattern
- client.agent("model").preamble("...").build() produces an Agent that implements Prompt
- Client::new() handles CLI discovery and returns actionable errors
- Internal types are hidden behind the facade
</success_criteria>

<output>
After completion, create `.planning/phases/07-rig-integration-polish/07-02-SUMMARY.md`
</output>
