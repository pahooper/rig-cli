---
phase: 07-rig-integration-polish
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - rig-cli/src/claude.rs
  - rig-cli/src/codex.rs
  - rig-cli/src/opencode.rs
  - rig-cli/src/lib.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "cargo check -p rig-cli produces zero warnings (no dead_code warnings for payload or model_name fields)"
    - "When payload is set via .with_payload(), the prompt text in completion() is restructured into XML with <context> and <task> tags"
    - "No TODO comments or tracing::info! about deferred MCP routing remain in any provider file"
    - "Doc comments accurately describe the architecture: completion() uses direct CLI, MCP enforcement is via ExtractionOrchestrator"
  artifacts:
    - path: "rig-cli/src/claude.rs"
      provides: "Claude provider with payload wiring and accurate docs"
      contains: "<context>"
    - path: "rig-cli/src/codex.rs"
      provides: "Codex provider with payload wiring and accurate docs"
      contains: "<context>"
    - path: "rig-cli/src/opencode.rs"
      provides: "OpenCode provider with payload wiring and accurate docs"
      contains: "<context>"
    - path: "rig-cli/src/lib.rs"
      provides: "Accurate crate-level documentation"
  key_links:
    - from: "rig-cli/src/claude.rs"
      to: "claudecode_adapter::RunConfig"
      via: "prompt restructuring with payload XML before cli.run()"
      pattern: "<context>"
    - from: "rig-cli/src/codex.rs"
      to: "codex_adapter::CodexConfig"
      via: "prompt restructuring with payload XML before cli.run()"
      pattern: "<context>"
    - from: "rig-cli/src/opencode.rs"
      to: "opencode_adapter::OpenCodeConfig"
      via: "prompt restructuring with payload XML before cli.run()"
      pattern: "<context>"
---

<objective>
Close verification gaps in Phase 7 by cleaning up misleading MCP routing code, wiring payload injection into the direct CLI execution path, eliminating dead code warnings, and updating documentation to accurately reflect the architecture.

Purpose: The verification report found 3 gaps — misleading completion_with_mcp() code, unused payload fields, and inaccurate doc comments claiming MCP enforcement in completion(). The root cause is architectural: CompletionRequest provides ToolDefinitions (JSON schemas), not executable Tool trait objects, so routing completion() through McpToolAgent is impossible. MCP enforcement correctly happens via ExtractionOrchestrator (which has concrete ToolSet objects). This plan aligns the code and docs with reality.

Output: All three provider files (claude.rs, codex.rs, opencode.rs) with working payload injection, zero dead_code warnings, no misleading TODO/tracing comments, and accurate documentation. The lib.rs crate docs updated to describe the correct architecture.
</objective>

<execution_context>
@/home/pnod/.claude/get-shit-done/workflows/execute-plan.md
@/home/pnod/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-rig-integration-polish/07-VERIFICATION.md
@.planning/phases/07-rig-integration-polish/07-02-SUMMARY.md
@.planning/phases/07-rig-integration-polish/07-03-SUMMARY.md

Key existing code to reference:
@rig-cli/src/claude.rs
@rig-cli/src/codex.rs
@rig-cli/src/opencode.rs
@rig-cli/src/lib.rs
@rig-cli/src/response.rs
@rig-cli/src/config.rs
@rig-provider/src/mcp_agent.rs (lines 452-469 for payload XML format reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up Claude provider — wire payload, remove misleading MCP code, fix docs</name>
  <files>rig-cli/src/claude.rs</files>
  <action>
Modify rig-cli/src/claude.rs to close all three verification gaps for the Claude provider:

**1. Remove misleading completion_with_mcp() method entirely.**
The method at lines 336-352 pretends MCP routing exists but just falls back to direct CLI with a tracing::info! about the limitation. Delete it completely.

**2. Simplify the completion() method.**
Remove the `if !request.tools.is_empty()` branch that calls `completion_with_mcp()`. The completion() method should always use the direct CLI path. If tools are present in the request, pass them as allowed_tools on the RunConfig (the current streaming path already does this correctly at lines 281-284 — replicate that pattern for completion).

The new completion() should:
- Extract prompt via `rig_provider::utils::format_chat_history(&request)`
- Extract preamble from `request.preamble`
- If `self.payload` is Some, restructure the prompt into XML format matching McpToolAgent's pattern (see rig-provider/src/mcp_agent.rs lines 453-466):
  ```
  <context>
  {payload_data}
  </context>

  <task>
  {original_prompt}
  </task>
  ```
- Build RunConfig with timeout, system_prompt (if preamble present), and allowed_tools (if request.tools non-empty)
- Run cli.run() with the (possibly restructured) prompt
- Return CompletionResponse with CliResponse

**3. Remove the separate completion_without_mcp() method.**
Its logic merges into the single completion() method.

**4. Fix unused field warnings.**
The `model_name` field on Model is never read. Add `#[allow(dead_code)]` with a doc comment: "Model identifier passed by Rig's CompletionClient. CLI agents don't use model selection per-request, but the field is kept for future use and API consistency." This is the correct approach because Rig's CompletionModel::make() requires accepting a model parameter.

The `payload` field IS now used (for prompt restructuring), so its dead_code warning resolves naturally.

**5. Update doc comments to be accurate.**
- Module-level doc (lines 1-27): Remove claims about MCP enforcement in completion(). Replace with: "Simple prompts and tool-bearing requests both use direct CLI execution. For MCP-enforced structured extraction, use `ExtractionOrchestrator` with `JsonSchemaToolkit`."
- Client struct doc (lines 59-77): Remove the "MCP Enforcement" section that claims tool-bearing requests route through McpToolAgent. Replace with a section about payload injection and a pointer to ExtractionOrchestrator for MCP enforcement.
- Model struct doc (lines 203-209): Remove "routes requests through either McpToolAgent or direct CLI" language. State it uses direct CLI execution, and payload data is injected via XML context wrapping.
- with_payload() doc (lines 152-170): Remove "The payload is passed to McpToolAgentBuilder::payload()" claim. Replace with: "When set, prompts are restructured into XML format with `<context>` and `<task>` tags, clearly separating data from instructions."

**6. Remove the CliResponse struct definition that's duplicated in claude.rs (lines 44-57).**
This struct is already defined in response.rs. claude.rs should use `use crate::response::CliResponse;` like codex.rs and opencode.rs do. Check if claude.rs currently imports from response.rs or defines its own — if it defines its own, switch to the shared one. (Based on the code read, claude.rs defines its own CliResponse at lines 44-57 and does NOT import from response.rs. Fix this.)

**What NOT to do:**
- Do NOT try to implement McpToolAgent routing in completion(). This is architecturally impossible (ToolDefinitions are not executable Tools).
- Do NOT remove the payload field from Model. It is now used for prompt restructuring.
- Do NOT remove the `request.tools` handling for allowed_tools in RunConfig — that's useful metadata for the CLI even without MCP enforcement.
  </action>
  <verify>
Run `cargo check -p rig-cli 2>&1 | grep -c "warning"` — should output 0 (zero warnings).
Run `grep -n "completion_with_mcp\|completion_without_mcp" rig-cli/src/claude.rs` — should return no matches.
Run `grep -n "TODO\|tracing::info.*ToolDefinition\|tracing::info.*fallback" rig-cli/src/claude.rs` — should return no matches.
Run `grep -n "<context>" rig-cli/src/claude.rs` — should return at least one match (payload XML restructuring).
  </verify>
  <done>
claude.rs has a single completion() method using direct CLI execution, payload is wired into prompt as XML context wrapping, no dead_code warnings from this file, no misleading MCP doc comments, no TODO or fallback tracing, and uses shared CliResponse from response.rs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up Codex, OpenCode providers and lib.rs docs</name>
  <files>rig-cli/src/codex.rs, rig-cli/src/opencode.rs, rig-cli/src/lib.rs</files>
  <action>
Apply the same gap closure pattern to codex.rs, opencode.rs, and update lib.rs crate documentation.

**For codex.rs:**

1. Remove the TODO comment at lines 156-158 ("Route through McpToolAgent for MCP-enforced structured extraction...").

2. Wire payload into completion():
   - If `self.payload` is Some, restructure `prompt_text` into XML format:
     ```
     <context>
     {payload_data}
     </context>

     <task>
     {original_prompt}
     </task>
     ```
   - This happens BEFORE passing to `cli.run()`.

3. Wire preamble into CodexConfig:
   - Currently completion() uses `CodexConfig::default()` which ignores the preamble entirely.
   - Set `config.system_prompt = request.preamble.clone()` so the preamble is actually used.
   - Set `config.timeout = self.config.timeout` so the client config timeout is respected.

4. Update doc comments:
   - Module-level doc: Remove "MCP-enforced CompletionModel" from the first line. Replace with "Codex provider client with CompletionModel." Remove the "Note on MCP Enforcement" section at lines 21-25. Replace with a note about ExtractionOrchestrator for MCP enforcement.
   - Model struct doc (lines 125-129): Remove "routing tool-bearing requests through McpToolAgent" language. State it uses direct CLI execution.
   - with_payload() doc: Remove "Maps to McpToolAgentBuilder::payload()" claim. Replace with: "When set, prompts are restructured into XML format with `<context>` and `<task>` tags."

5. Fix payload dead_code warning: The payload field is now used in completion(), so the warning resolves naturally.

**For opencode.rs:**
Apply identical changes as codex.rs. The files follow the same pattern. For OpenCode:
- Set `config.prompt = request.preamble.clone()` (OpenCodeConfig uses `prompt` field, not `system_prompt`)
- Set `config.timeout = self.config.timeout`

**For lib.rs:**
Update the crate-level documentation (lines 1-68) to accurately describe the architecture:

1. In the "Structured Extraction with MCP" section (lines 27-61): This section is already accurate — it shows ExtractionOrchestrator usage. Keep it.

2. Add a brief architecture note after the Quick Start section explaining:
   - `client.agent().prompt()` uses direct CLI execution (fast, simple)
   - For MCP-enforced structured extraction, use `ExtractionOrchestrator` + `JsonSchemaToolkit` (the example already shown)
   - For advanced MCP use cases, use `rig_provider::mcp_agent::McpToolAgent` directly (escape hatch)

3. Remove any language in the doc that implies completion() routes through MCP. (Check if any exists in lib.rs — based on reading, the lib.rs docs are already mostly accurate since they show the ExtractionOrchestrator pattern.)

**What NOT to do:**
- Do NOT change the streaming implementation — it works correctly.
- Do NOT add McpToolAgent routing to completion(). The architecture is correct as direct CLI.
- Do NOT change the CompletionClient trait implementations — those are correct.
  </action>
  <verify>
Run `cargo check -p rig-cli 2>&1 | grep -c "warning"` — should output 0 (zero warnings from rig-cli).
Run `grep -rn "TODO.*McpToolAgent\|TODO.*MCP" rig-cli/src/codex.rs rig-cli/src/opencode.rs` — should return no matches.
Run `grep -rn "<context>" rig-cli/src/codex.rs rig-cli/src/opencode.rs` — should return matches (payload XML wired).
Run `grep -rn "MCP-enforced CompletionModel" rig-cli/src/codex.rs rig-cli/src/opencode.rs` — should return no matches.
Run `cargo test -p rig-cli` — all existing tests pass.
Run `cargo doc -p rig-cli --no-deps 2>&1 | grep -c "warning"` — should output 0 (no doc warnings).
  </verify>
  <done>
codex.rs and opencode.rs have payload wired into prompt as XML context wrapping, preamble and timeout wired into adapter configs, no TODO comments about MCP, no dead_code warnings, and accurate doc comments. lib.rs crate docs accurately describe the two execution paths (direct CLI for prompts, ExtractionOrchestrator for MCP-enforced extraction).
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full gap closure:

1. `cargo check -p rig-cli 2>&1` — zero warnings (no dead_code, no unused fields)
2. `cargo test -p rig-cli` — all tests pass
3. `grep -rn "completion_with_mcp\|completion_without_mcp" rig-cli/src/` — no matches (misleading methods removed)
4. `grep -rn "TODO.*MCP\|TODO.*McpToolAgent" rig-cli/src/` — no matches (TODO comments cleaned)
5. `grep -rn "tracing::info.*ToolDefinition\|tracing::info.*fallback" rig-cli/src/` — no matches (misleading tracing removed)
6. `grep -rn "<context>" rig-cli/src/claude.rs rig-cli/src/codex.rs rig-cli/src/opencode.rs` — matches in all three files (payload wired)
7. `cargo doc -p rig-cli --no-deps 2>&1` — no doc warnings, accurate descriptions
</verification>

<success_criteria>
- Zero compilation warnings from `cargo check -p rig-cli`
- All three provider files wire payload into prompt via XML `<context>`/`<task>` restructuring
- No misleading MCP routing code, TODO comments, or fallback tracing remain
- Doc comments accurately describe: direct CLI for completion(), ExtractionOrchestrator for MCP enforcement
- All existing tests pass
- The CliResponse type in claude.rs uses the shared response.rs definition (no duplication)
</success_criteria>

<output>
After completion, create `.planning/phases/07-rig-integration-polish/07-05-SUMMARY.md`
</output>
